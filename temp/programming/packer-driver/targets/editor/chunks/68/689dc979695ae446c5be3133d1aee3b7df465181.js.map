{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/models/GameModel.ts"],"names":["GameModel","CardModel","constructor","_allCards","Map","_tableCards","_handCards","_topCard","_reserveCards","_initialReserveCards","initialize","levelConfig","clearAll","Playfield","forEach","config","index","card","currentArea","zIndex","set","id","Stack","handCards","Array","from","values","length","slice","clear","allCards","tableCards","getCardById","get","getLastHandCard","cards","topCard","reserveCards","updateTopAndReserveCards","canMatch","tableCard","handCard","Math","abs","CardFace","executeMatch","tableCardId","CardSuit","delete","replaceLastHandCard","cardId","lastCard","getAllCardsState","states","face","suit","isFaceUp","isLocked","area","position","restoreAllCardsState","state","recalculateTopAndReserveCards","sort","a","b"],"mappings":"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","sourcesContent":["import { LevelConfig } from './CardData';\r\nimport { CardModel, CardState } from './CardModel';\r\n\r\n/**\r\n * 游戏模型，负责管理游戏的核心数据和状态\r\n */\r\nexport class GameModel {\r\n    private _allCards: Map<string, CardModel> = new Map();\r\n    private _tableCards: Map<string, CardModel> = new Map();\r\n    private _handCards: Map<string, CardModel> = new Map();\r\n    private _topCard: CardModel = null;\r\n    private _reserveCards: CardModel[] = [];\r\n    private _initialReserveCards: CardModel[] = [];\r\n\r\n    constructor() {}\r\n\r\n    public initialize(levelConfig: LevelConfig): void {\r\n        this.clearAll();\r\n\r\n        // 初始化桌面牌\r\n        if (levelConfig?.Playfield) {\r\n            levelConfig.Playfield.forEach((config, index) => {\r\n                const card = new CardModel(config, `table_${index}`);\r\n                card.currentArea = 'table';\r\n                card.zIndex = index;\r\n                this._tableCards.set(card.id, card);\r\n                this._allCards.set(card.id, card);\r\n            });\r\n        }\r\n\r\n        // 初始化手牌\r\n        if (levelConfig?.Stack) {\r\n            levelConfig.Stack.forEach((config, index) => {\r\n                const card = new CardModel(config, `hand_${index}`);\r\n                card.currentArea = 'hand';\r\n                card.zIndex = index;\r\n                this._handCards.set(card.id, card);\r\n                this._allCards.set(card.id, card);\r\n            });\r\n\r\n            // 设置初始顶牌和备用牌\r\n            const handCards = Array.from(this._handCards.values());\r\n            if (handCards.length > 0) {\r\n                this._topCard = handCards[handCards.length - 1];\r\n                this._initialReserveCards = handCards.slice(0, handCards.length - 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    public clearAll(): void {\r\n        this._allCards.clear();\r\n        this._tableCards.clear();\r\n        this._handCards.clear();\r\n    }\r\n\r\n    public get allCards(): Map<string, CardModel> {\r\n        return this._allCards;\r\n    }\r\n\r\n    public get tableCards(): Map<string, CardModel> {\r\n        return this._tableCards;\r\n    }\r\n\r\n    public get handCards(): Map<string, CardModel> {\r\n        return this._handCards;\r\n    }\r\n\r\n    public getCardById(id: string): CardModel | undefined {\r\n        return this._allCards.get(id);\r\n    }\r\n\r\n    public getLastHandCard(): CardModel | undefined {\r\n        const cards = Array.from(this._handCards.values());\r\n        return cards[cards.length - 1];\r\n    }\r\n\r\n    public get topCard(): CardModel {\r\n        return this._topCard;\r\n    }\r\n\r\n    public set topCard(card: CardModel) {\r\n        this._topCard = card;\r\n    }\r\n\r\n    public get reserveCards(): CardModel[] {\r\n        return this._reserveCards;\r\n    }\r\n\r\n    public set reserveCards(cards: CardModel[]) {\r\n        this._reserveCards = cards;\r\n    }\r\n\r\n    // 更新顶牌和备用牌\r\n    public updateTopAndReserveCards(): void {\r\n        this._reserveCards = [...this._initialReserveCards];\r\n    }\r\n\r\n    // 判断两张牌是否可以匹配（点数绝对值差1）\r\n    public canMatch(tableCard: CardModel, handCard: CardModel): boolean {\r\n        return Math.abs(tableCard.config.CardFace - handCard.config.CardFace) === 1;\r\n    }\r\n\r\n    // 执行匹配操作\r\n    public executeMatch(tableCardId: string): boolean {\r\n        const tableCard = this._allCards.get(tableCardId);\r\n        const handCard = this.getLastHandCard();\r\n\r\n        if (!tableCard || !handCard) return false;\r\n        if (tableCard.currentArea !== 'table') return false;\r\n        if (!this.canMatch(tableCard, handCard)) return false;\r\n\r\n        // 更新桌面卡牌\r\n        tableCard.config.CardFace = handCard.config.CardFace;\r\n        tableCard.config.CardSuit = handCard.config.CardSuit;\r\n\r\n        // 移除手牌\r\n        this._handCards.delete(handCard.id);\r\n        this._allCards.delete(handCard.id);\r\n\r\n        return true;\r\n    }\r\n\r\n    // 替换手牌最后一张\r\n    public replaceLastHandCard(cardId: string): boolean {\r\n        const card = this._allCards.get(cardId);\r\n        if (!card || card.currentArea !== 'hand') return false;\r\n\r\n        const cards = Array.from(this._handCards.values());\r\n        const lastCard = cards[cards.length - 1];\r\n        if (lastCard.id === cardId) return false;\r\n\r\n        // 交换zIndex\r\n        [card.zIndex, lastCard.zIndex] = [lastCard.zIndex, card.zIndex];\r\n        return true;\r\n    }\r\n\r\n    // 获取所有卡牌的状态快照\r\n    public getAllCardsState(): Map<string, CardState> {\r\n        const states = new Map<string, CardState>();\r\n        this._allCards.forEach((card, id) => {\r\n            states.set(id, {\r\n                id: card.id,\r\n                face: card.config.CardFace,\r\n                suit: card.config.CardSuit,\r\n                isFaceUp: card.isFaceUp,\r\n                isLocked: card.isLocked,\r\n                area: card.currentArea,\r\n                position: { ...card.position },\r\n                zIndex: card.zIndex\r\n            });\r\n        });\r\n        return states;\r\n    }\r\n\r\n    // 恢复所有卡牌状态\r\n    public restoreAllCardsState(states: Map<string, CardState>): void {\r\n        states.forEach((state, id) => {\r\n            const card = this._allCards.get(id);\r\n            if (card) {\r\n                card.config.CardFace = state.face;\r\n                card.config.CardSuit = state.suit;\r\n                card.isFaceUp = state.isFaceUp;\r\n                card.isLocked = state.isLocked;\r\n                card.currentArea = state.area;\r\n                card.position = { ...state.position };\r\n                card.zIndex = state.zIndex;\r\n\r\n                // 更新区域映射\r\n                if (state.area === 'table') {\r\n                    this._tableCards.set(id, card);\r\n                    this._handCards.delete(id);\r\n                } else if (state.area === 'hand') {\r\n                    this._handCards.set(id, card);\r\n                    this._tableCards.delete(id);\r\n                }\r\n            }\r\n        });\r\n        \r\n        this.recalculateTopAndReserveCards();\r\n    }\r\n    \r\n    // 重新计算顶牌和备用牌\r\n    private recalculateTopAndReserveCards(): void {\r\n        const handCards = Array.from(this._handCards.values());\r\n        handCards.sort((a, b) => a.zIndex - b.zIndex);\r\n        \r\n        if (handCards.length > 0) {\r\n            this._topCard = handCards[handCards.length - 1];\r\n            this._reserveCards = handCards.slice(0, handCards.length - 1);\r\n        } else {\r\n            this._topCard = null;\r\n            this._reserveCards = [];\r\n        }\r\n    }\r\n}\r\n"]}