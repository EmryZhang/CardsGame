{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/models/GameModel.ts"],"names":["GameModel","CardModel","constructor","_allCards","Map","_tableCards","_handCards","initialize","levelConfig","clearAll","Playfield","forEach","config","index","card","currentArea","zIndex","set","id","Stack","clear","allCards","tableCards","handCards","getCardById","get","getLastHandCard","cards","Array","from","values","length","canMatch","tableCard","handCard","Math","abs","CardFace","executeMatch","tableCardId","CardSuit","delete","replaceLastHandCard","cardId","lastIndex","lastCard","tempZIndex","getAllCardsState","states","face","suit","isFaceUp","isLocked","area","position","restoreAllCardsState","state"],"mappings":"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","sourcesContent":["/**\r\n * 游戏模型\r\n * 负责管理游戏的核心数据和状态\r\n */\r\nimport { CardConfig, LevelConfig } from './CardData';\r\nimport { CardModel, CardState } from './CardModel';\r\n\r\nexport class GameModel {\r\n    // 所有卡牌\r\n    private _allCards: Map<string, CardModel> = new Map();\r\n\r\n    // 桌面卡牌\r\n    private _tableCards: Map<string, CardModel> = new Map();\r\n\r\n    // 手牌\r\n    private _handCards: Map<string, CardModel> = new Map();\r\n\r\n    constructor() {\r\n    }\r\n\r\n    /**\r\n     * 初始化游戏数据\r\n     */\r\n    public initialize(levelConfig: LevelConfig): void {\r\n        this.clearAll();\r\n\r\n        // 初始化桌面牌\r\n        if (levelConfig?.Playfield) {\r\n            levelConfig.Playfield.forEach((config, index) => {\r\n                const card = new CardModel(config, `table_${index}`);\r\n                card.currentArea = 'table';\r\n                card.zIndex = index;\r\n                this._tableCards.set(card.id, card);\r\n                this._allCards.set(card.id, card);\r\n            });\r\n        }\r\n\r\n        // 初始化手牌\r\n        if (levelConfig?.Stack) {\r\n            levelConfig.Stack.forEach((config, index) => {\r\n                const card = new CardModel(config, `hand_${index}`);\r\n                card.currentArea = 'hand';\r\n                card.zIndex = index;\r\n                this._handCards.set(card.id, card);\r\n                this._allCards.set(card.id, card);\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 清空所有数据\r\n     */\r\n    public clearAll(): void {\r\n        this._allCards.clear();\r\n        this._tableCards.clear();\r\n        this._handCards.clear();\r\n    }\r\n\r\n    /**\r\n     * 获取所有卡牌\r\n     */\r\n    public get allCards(): Map<string, CardModel> {\r\n        return this._allCards;\r\n    }\r\n\r\n    /**\r\n     * 获取桌面卡牌\r\n     */\r\n    public get tableCards(): Map<string, CardModel> {\r\n        return this._tableCards;\r\n    }\r\n\r\n    /**\r\n     * 获取手牌\r\n     */\r\n    public get handCards(): Map<string, CardModel> {\r\n        return this._handCards;\r\n    }\r\n\r\n    /**\r\n     * 根据ID获取卡牌\r\n     */\r\n    public getCardById(id: string): CardModel | undefined {\r\n        return this._allCards.get(id);\r\n    }\r\n\r\n    /**\r\n     * 获取手牌最后一张\r\n     */\r\n    public getLastHandCard(): CardModel | undefined {\r\n        const cards = Array.from(this._handCards.values());\r\n        return cards[cards.length - 1];\r\n    }\r\n\r\n    /**\r\n     * 判断两张牌是否可以匹配（点数绝对值差1）\r\n     */\r\n    public canMatch(tableCard: CardModel, handCard: CardModel): boolean {\r\n        return Math.abs(tableCard.config.CardFace - handCard.config.CardFace) === 1;\r\n    }\r\n\r\n    /**\r\n     * 执行匹配操作\r\n     * @param tableCardId 桌面卡牌ID\r\n     * @returns 是否成功匹配\r\n     */\r\n    public executeMatch(tableCardId: string): boolean {\r\n        const tableCard = this._allCards.get(tableCardId);\r\n        const handCard = this.getLastHandCard();\r\n\r\n        if (!tableCard || !handCard) return false;\r\n        if (tableCard.currentArea !== 'table') return false;\r\n        if (!this.canMatch(tableCard, handCard)) return false;\r\n\r\n        // 更新桌面卡牌为手牌最后一张\r\n        tableCard.config.CardFace = handCard.config.CardFace;\r\n        tableCard.config.CardSuit = handCard.config.CardSuit;\r\n\r\n        // 移除手牌最后一张\r\n        this._handCards.delete(handCard.id);\r\n        this._allCards.delete(handCard.id);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 替换手牌最后一张\r\n     * @param cardId 要替换的卡牌ID\r\n     * @returns 是否成功替换\r\n     */\r\n    public replaceLastHandCard(cardId: string): boolean {\r\n        const card = this._allCards.get(cardId);\r\n        if (!card || card.currentArea !== 'hand') return false;\r\n\r\n        const cards = Array.from(this._handCards.values());\r\n        const lastIndex = cards.length - 1;\r\n        const lastCard = cards[lastIndex];\r\n\r\n        if (lastCard.id === cardId) return false; // 已经是最后一张\r\n\r\n        // 交换位置（通过调整zIndex实现）\r\n        const tempZIndex = card.zIndex;\r\n        card.zIndex = lastCard.zIndex;\r\n        lastCard.zIndex = tempZIndex;\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 获取所有卡牌的状态\r\n     */\r\n    public getAllCardsState(): Map<string, CardState> {\r\n        const states = new Map<string, CardState>();\r\n        this._allCards.forEach((card, id) => {\r\n            states.set(id, {\r\n                id: card.id,\r\n                face: card.config.CardFace,\r\n                suit: card.config.CardSuit,\r\n                isFaceUp: card.isFaceUp,\r\n                isLocked: card.isLocked,\r\n                area: card.currentArea,\r\n                position: { ...card.position },\r\n                zIndex: card.zIndex\r\n            });\r\n        });\r\n        return states;\r\n    }\r\n\r\n    /**\r\n     * 恢复所有卡牌的状态\r\n     */\r\n    public restoreAllCardsState(states: Map<string, CardState>): void {\r\n        states.forEach((state, id) => {\r\n            const card = this._allCards.get(id);\r\n            if (card) {\r\n                card.config.CardFace = state.face;\r\n                card.config.CardSuit = state.suit;\r\n                card.isFaceUp = state.isFaceUp;\r\n                card.isLocked = state.isLocked;\r\n                card.currentArea = state.area;\r\n                card.position = { ...state.position };\r\n                card.zIndex = state.zIndex;\r\n\r\n                // 根据区域更新Map\r\n                if (state.area === 'table') {\r\n                    this._tableCards.set(id, card);\r\n                    this._handCards.delete(id);\r\n                } else if (state.area === 'hand') {\r\n                    this._handCards.set(id, card);\r\n                    this._tableCards.delete(id);\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n"]}