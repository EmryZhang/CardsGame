{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/managers/DataManager.ts"],"names":["DataManager","JsonAsset","resources","GameModel","UndoModel","ActionType","_currentLevelConfig","_currentLevelId","_gameModel","_undoModel","instance","_instance","loadLevel","levelId","Promise","resolve","levelPath","load","err","asset","console","error","json","initialize","clearAllData","clearAll","clearHistory","currentLevelConfig","currentLevelId","gameModel","undoModel","executeMatch","tableCardId","saveStateBeforeAction","type","MATCH","replaceLastHandCard","cardId","REPLACE","action","cardsState","getAllCardsState","saveAction","undo","record","restoreAllCardsState","getHistoryCount","canUndo"],"mappings":"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","sourcesContent":["/**\r\n * 游戏数据管理器\r\n * 负责管理游戏流程，数据操作委托给Models层\r\n */\r\nimport { JsonAsset, resources } from 'cc';\r\nimport { LevelConfig } from '../models/CardData';\r\nimport { GameModel } from '../models/GameModel';\r\nimport { UndoModel, ActionType, GameAction } from '../models/UndoModel';\r\n\r\nexport class DataManager {\r\n    private static _instance: DataManager = null;\r\n\r\n    // 静态配置数据\r\n    private _currentLevelConfig: LevelConfig = null;\r\n    private _currentLevelId: number = 1;\r\n\r\n    // 数据模型\r\n    private _gameModel: GameModel = new GameModel();\r\n    private _undoModel: UndoModel = new UndoModel();\r\n\r\n    public static get instance(): DataManager {\r\n        if (!this._instance) {\r\n            this._instance = new DataManager();\r\n        }\r\n        return this._instance;\r\n    }\r\n\r\n    /**\r\n     * 加载关卡配置\r\n     * @param levelId 关卡ID\r\n     */\r\n    public async loadLevel(levelId: number): Promise<boolean> {\r\n        return new Promise((resolve) => {\r\n            const levelPath = `levels/level_${levelId}`;\r\n            resources.load(levelPath, JsonAsset, (err, asset) => {\r\n                if (err) {\r\n                    console.error(`加载关卡 ${levelId} 失败:`, err);\r\n                    resolve(false);\r\n                    return;\r\n                }\r\n\r\n                this._currentLevelConfig = asset.json as LevelConfig;\r\n                this._currentLevelId = levelId;\r\n                this._gameModel.initialize(this._currentLevelConfig);\r\n                resolve(true);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 清空所有数据\r\n     */\r\n    public clearAllData(): void {\r\n        this._gameModel.clearAll();\r\n        this._undoModel.clearHistory();\r\n    }\r\n\r\n    /**\r\n     * 获取当前关卡配置\r\n     */\r\n    public get currentLevelConfig(): LevelConfig {\r\n        return this._currentLevelConfig;\r\n    }\r\n\r\n    /**\r\n     * 获取当前关卡ID\r\n     */\r\n    public get currentLevelId(): number {\r\n        return this._currentLevelId;\r\n    }\r\n\r\n    /**\r\n     * 获取游戏模型\r\n     */\r\n    public get gameModel(): GameModel {\r\n        return this._gameModel;\r\n    }\r\n\r\n    /**\r\n     * 获取回退模型\r\n     */\r\n    public get undoModel(): UndoModel {\r\n        return this._undoModel;\r\n    }\r\n\r\n    /**\r\n     * 执行匹配操作\r\n     * @param tableCardId 桌面卡牌ID\r\n     * @returns 是否成功匹配\r\n     */\r\n    public executeMatch(tableCardId: string): boolean {\r\n        // 保存操作前的状态\r\n        this.saveStateBeforeAction({\r\n            type: ActionType.MATCH,\r\n            tableCardId: tableCardId\r\n        });\r\n\r\n        // 执行匹配\r\n        return this._gameModel.executeMatch(tableCardId);\r\n    }\r\n\r\n    /**\r\n     * 替换手牌最后一张\r\n     * @param cardId 要替换的卡牌ID\r\n     * @returns 是否成功替换\r\n     */\r\n    public replaceLastHandCard(cardId: string): boolean {\r\n        // 保存操作前的状态\r\n        this.saveStateBeforeAction({\r\n            type: ActionType.REPLACE,\r\n            cardId: cardId\r\n        });\r\n\r\n        // 执行替换\r\n        return this._gameModel.replaceLastHandCard(cardId);\r\n    }\r\n\r\n    /**\r\n     * 保存操作前的状态\r\n     */\r\n    private saveStateBeforeAction(action: GameAction): void {\r\n        const cardsState = this._gameModel.getAllCardsState();\r\n        this._undoModel.saveAction(action, cardsState);\r\n    }\r\n\r\n    /**\r\n     * 撤销上一步操作\r\n     * @returns 是否成功撤销\r\n     */\r\n    public undo(): boolean {\r\n        const record = this._undoModel.undo();\r\n        if (!record) return false;\r\n\r\n        this._gameModel.restoreAllCardsState(record.cardsState);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 清空历史记录\r\n     */\r\n    public clearHistory(): void {\r\n        this._undoModel.clearHistory();\r\n    }\r\n\r\n    /**\r\n     * 获取历史记录数量\r\n     */\r\n    public getHistoryCount(): number {\r\n        return this._undoModel.getHistoryCount();\r\n    }\r\n\r\n    /**\r\n     * 检查是否可以撤销\r\n     */\r\n    public canUndo(): boolean {\r\n        return this._undoModel.canUndo();\r\n    }\r\n}\r\n"]}