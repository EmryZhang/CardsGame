{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/managers/DataManager.ts"],"names":["DataManager","JsonAsset","resources","GameModel","ActionType","UndoModel","_currentLevelConfig","_currentLevelId","_gameModel","_undoModel","instance","_instance","loadLevel","levelId","Promise","resolve","levelPath","load","err","asset","console","error","json","initialize","clearAllData","clearAll","clearHistory","currentLevelConfig","currentLevelId","gameModel","undoModel","executeMatch","tableCardId","saveStateBeforeAction","type","MATCH","replaceLastHandCard","cardId","REPLACE","action","cardsState","getAllCardsState","saveAction","undo","record","restoreAllCardsState","getHistoryCount","canUndo"],"mappings":";;;uIAQaA,W;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AARJC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,S,OAAAA,S;;AAEXC,MAAAA,S,iBAAAA,S;;AACAC,MAAAA,U,iBAAAA,U;AAAwBC,MAAAA,S,iBAAAA,S;;;;;;;;;AAEjC;AACA;AACA;6BACaL,W,GAAN,MAAMA,WAAN,CAAkB;AAAA;AAAA,eAGbM,mBAHa,GAGsB,IAHtB;AAAA,eAIbC,eAJa,GAIa,CAJb;AAAA,eAKbC,UALa,GAKW;AAAA;AAAA,uCALX;AAAA,eAMbC,UANa,GAMW;AAAA;AAAA,uCANX;AAAA;;AAQK,mBAARC,QAAQ,GAAgB;AACtC,cAAI,CAAC,KAAKC,SAAV,EAAqB;AACjB,iBAAKA,SAAL,GAAiB,IAAIX,WAAJ,EAAjB;AACH;;AACD,iBAAO,KAAKW,SAAZ;AACH,SAboB,CAerB;;;AACsB,cAATC,SAAS,CAACC,OAAD,EAAoC;AACtD,iBAAO,IAAIC,OAAJ,CAAaC,OAAD,IAAa;AAC5B,kBAAMC,SAAS,GAAI,gBAAeH,OAAQ,EAA1C;AACAX,YAAAA,SAAS,CAACe,IAAV,CAAeD,SAAf,EAA0Bf,SAA1B,EAAqC,CAACiB,GAAD,EAAMC,KAAN,KAAgB;AACjD,kBAAID,GAAJ,EAAS;AACLE,gBAAAA,OAAO,CAACC,KAAR,CAAe,QAAOR,OAAQ,MAA9B,EAAqCK,GAArC;AACAH,gBAAAA,OAAO,CAAC,KAAD,CAAP;AACA;AACH;;AAED,mBAAKT,mBAAL,GAA2Ba,KAAK,CAACG,IAAjC;AACA,mBAAKf,eAAL,GAAuBM,OAAvB;;AACA,mBAAKL,UAAL,CAAgBe,UAAhB,CAA2B,KAAKjB,mBAAhC;;AACAS,cAAAA,OAAO,CAAC,IAAD,CAAP;AACH,aAXD;AAYH,WAdM,CAAP;AAeH,SAhCoB,CAkCrB;;;AACOS,QAAAA,YAAY,GAAS;AACxB,eAAKhB,UAAL,CAAgBiB,QAAhB;;AACA,eAAKhB,UAAL,CAAgBiB,YAAhB;AACH;;AAE4B,YAAlBC,kBAAkB,GAAgB;AACzC,iBAAO,KAAKrB,mBAAZ;AACH;;AAEwB,YAAdsB,cAAc,GAAW;AAChC,iBAAO,KAAKrB,eAAZ;AACH;;AAEmB,YAATsB,SAAS,GAAc;AAC9B,iBAAO,KAAKrB,UAAZ;AACH;;AAEmB,YAATsB,SAAS,GAAc;AAC9B,iBAAO,KAAKrB,UAAZ;AACH,SAtDoB,CAwDrB;;;AACOsB,QAAAA,YAAY,CAACC,WAAD,EAA+B;AAC9C,eAAKC,qBAAL,CAA2B;AACvBC,YAAAA,IAAI,EAAE;AAAA;AAAA,0CAAWC,KADM;AAEvBH,YAAAA,WAAW,EAAEA;AAFU,WAA3B;AAIA,iBAAO,KAAKxB,UAAL,CAAgBuB,YAAhB,CAA6BC,WAA7B,CAAP;AACH,SA/DoB,CAiErB;;;AACOI,QAAAA,mBAAmB,CAACC,MAAD,EAA0B;AAChD,eAAKJ,qBAAL,CAA2B;AACvBC,YAAAA,IAAI,EAAE;AAAA;AAAA,0CAAWI,OADM;AAEvBD,YAAAA,MAAM,EAAEA;AAFe,WAA3B;AAIA,iBAAO,KAAK7B,UAAL,CAAgB4B,mBAAhB,CAAoCC,MAApC,CAAP;AACH,SAxEoB,CA0ErB;;;AACQJ,QAAAA,qBAAqB,CAACM,MAAD,EAA2B;AACpD,gBAAMC,UAAU,GAAG,KAAKhC,UAAL,CAAgBiC,gBAAhB,EAAnB;;AACA,eAAKhC,UAAL,CAAgBiC,UAAhB,CAA2BH,MAA3B,EAAmCC,UAAnC;AACH,SA9EoB,CAgFrB;;;AACOG,QAAAA,IAAI,GAAY;AACnB,gBAAMC,MAAM,GAAG,KAAKnC,UAAL,CAAgBkC,IAAhB,EAAf;;AACA,cAAI,CAACC,MAAL,EAAa,OAAO,KAAP;;AACb,eAAKpC,UAAL,CAAgBqC,oBAAhB,CAAqCD,MAAM,CAACJ,UAA5C;;AACA,iBAAO,IAAP;AACH,SAtFoB,CAwFrB;;;AACOd,QAAAA,YAAY,GAAS;AACxB,eAAKjB,UAAL,CAAgBiB,YAAhB;AACH,SA3FoB,CA6FrB;;;AACOoB,QAAAA,eAAe,GAAW;AAC7B,iBAAO,KAAKrC,UAAL,CAAgBqC,eAAhB,EAAP;AACH,SAhGoB,CAkGrB;;;AACOC,QAAAA,OAAO,GAAY;AACtB,iBAAO,KAAKtC,UAAL,CAAgBsC,OAAhB,EAAP;AACH;;AArGoB,O;;AAAZ/C,MAAAA,W,CACMW,S,GAAyB,I","sourcesContent":["import { JsonAsset, resources } from 'cc';\r\nimport { LevelConfig } from '../models/CardData';\r\nimport { GameModel } from '../models/GameModel';\r\nimport { ActionType, GameAction, UndoModel } from '../models/UndoModel';\r\n\r\n/**\r\n * 游戏数据管理器\r\n */\r\nexport class DataManager {\r\n    private static _instance: DataManager = null;\r\n    \r\n    private _currentLevelConfig: LevelConfig = null;\r\n    private _currentLevelId: number = 1;\r\n    private _gameModel: GameModel = new GameModel();\r\n    private _undoModel: UndoModel = new UndoModel();\r\n\r\n    public static get instance(): DataManager {\r\n        if (!this._instance) {\r\n            this._instance = new DataManager();\r\n        }\r\n        return this._instance;\r\n    }\r\n\r\n    // 加载关卡配置\r\n    public async loadLevel(levelId: number): Promise<boolean> {\r\n        return new Promise((resolve) => {\r\n            const levelPath = `levels/level_${levelId}`;\r\n            resources.load(levelPath, JsonAsset, (err, asset) => {\r\n                if (err) {\r\n                    console.error(`加载关卡 ${levelId} 失败:`, err);\r\n                    resolve(false);\r\n                    return;\r\n                }\r\n\r\n                this._currentLevelConfig = asset.json as LevelConfig;\r\n                this._currentLevelId = levelId;\r\n                this._gameModel.initialize(this._currentLevelConfig);\r\n                resolve(true);\r\n            });\r\n        });\r\n    }\r\n\r\n    // 清空所有数据\r\n    public clearAllData(): void {\r\n        this._gameModel.clearAll();\r\n        this._undoModel.clearHistory();\r\n    }\r\n\r\n    public get currentLevelConfig(): LevelConfig {\r\n        return this._currentLevelConfig;\r\n    }\r\n\r\n    public get currentLevelId(): number {\r\n        return this._currentLevelId;\r\n    }\r\n\r\n    public get gameModel(): GameModel {\r\n        return this._gameModel;\r\n    }\r\n\r\n    public get undoModel(): UndoModel {\r\n        return this._undoModel;\r\n    }\r\n\r\n    // 执行匹配操作\r\n    public executeMatch(tableCardId: string): boolean {\r\n        this.saveStateBeforeAction({\r\n            type: ActionType.MATCH,\r\n            tableCardId: tableCardId\r\n        });\r\n        return this._gameModel.executeMatch(tableCardId);\r\n    }\r\n\r\n    // 替换手牌最后一张\r\n    public replaceLastHandCard(cardId: string): boolean {\r\n        this.saveStateBeforeAction({\r\n            type: ActionType.REPLACE,\r\n            cardId: cardId\r\n        });\r\n        return this._gameModel.replaceLastHandCard(cardId);\r\n    }\r\n\r\n    // 保存操作前的状态\r\n    private saveStateBeforeAction(action: GameAction): void {\r\n        const cardsState = this._gameModel.getAllCardsState();\r\n        this._undoModel.saveAction(action, cardsState);\r\n    }\r\n\r\n    // 撤销上一步操作\r\n    public undo(): boolean {\r\n        const record = this._undoModel.undo();\r\n        if (!record) return false;\r\n        this._gameModel.restoreAllCardsState(record.cardsState);\r\n        return true;\r\n    }\r\n\r\n    // 清空历史记录\r\n    public clearHistory(): void {\r\n        this._undoModel.clearHistory();\r\n    }\r\n\r\n    // 获取历史记录数量\r\n    public getHistoryCount(): number {\r\n        return this._undoModel.getHistoryCount();\r\n    }\r\n\r\n    // 检查是否可以撤销\r\n    public canUndo(): boolean {\r\n        return this._undoModel.canUndo();\r\n    }\r\n}\r\n"]}