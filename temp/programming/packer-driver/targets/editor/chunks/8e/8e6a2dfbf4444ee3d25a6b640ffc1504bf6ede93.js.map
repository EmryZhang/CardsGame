{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/controllers/LevelController.ts"],"names":["_decorator","Color","Component","instantiate","Node","Prefab","Sprite","SpriteFrame","tween","Vec3","GameConfig","DataManager","CardService","CardUtils","CardView","ccclass","property","LevelController","historyStack","onLoad","initializeConfig","loadLevel","createCardsFromData","setupUndoButton","instance","initialize","success","console","error","gameModel","updateTopAndReserveCards","undoButton","warn","on","EventType","TOUCH_END","undoLastMove","cardPrefab","tableArea","removeAllChildren","layoutConfig","tableCards","forEach","cardData","createTableCard","totalHandCards","handCards","size","createHandCard","Array","from","values","length","topCard","cardNode","addChild","cardId","id","setupCardDisplay","setupTableCardPosition","cardView","getComponent","setClickCallback","view","onTableCardClick","relativePos","convertAbsoluteToRelativeForTable","position","x","y","setPosition","setSiblingIndex","zIndex","totalCards","setupHandCardPosition","onHandCardClick","handConf","handLayout","stackX","stackStartX","startY","stackStartY","spacingX","stackSpacingX","separateX","separateCardX","separateY","separateCardY","index","indexOf","posX","posY","updatePosition","config","isRed","isRedSuit","CardSuit","currentArea","init","setSprite","name","spriteFrame","node","getChildByName","sp","color","WHITE","getNumberSprite","CardFace","suitSprites","getCardName","face","isBig","arr","bigRedNumbers","bigBlackNumbers","smallRedNumbers","smallBlackNumbers","getCardDataFromNode","handleCardClick","currentTopCard","reserveCards","cardIndex","currentReserveCards","cardIndex2","splice","canMoveToCard","targetPosition","calculateTargetPosition","saveCardMoveRecord","to","start","lastHandCard","children","i","child","getPosition","currentPosition","previousReserveCardIds","map","card","push","fromPosition","toPosition","fromArea","toArea","previousTopCardId","lastRecord","pop","call","previousTopCard","getCardById","restoredReserveCards","onUndoClick","undo","refreshAllCardsDisplay","undefined"],"mappings":"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","sourcesContent":["import { _decorator, Color, Component, instantiate, Node, Prefab, Sprite, SpriteFrame, tween, Vec3 } from 'cc';\r\nimport { GameConfig } from '../../resources/configs/GameConfig';\r\nimport { DataManager } from '../managers/DataManager';\r\nimport { CardModel } from '../models/CardModel';\r\nimport { CardService } from '../services/CardService';\r\nimport { CardUtils } from '../utils/CardUtils';\r\nimport CardView from '../views/CardView';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n// 卡牌移动记录\r\ninterface CardMoveRecord {\r\n    cardId: string;\r\n    fromPosition: { x: number, y: number };\r\n    toPosition: { x: number, y: number };\r\n    fromArea: string;\r\n    toArea: string;\r\n    zIndex: number;\r\n    previousTopCardId: string | null;\r\n    previousReserveCardIds: string[];\r\n}\r\n\r\n@ccclass('LevelController')\r\nexport default class LevelController extends Component {\r\n    @property(Prefab) cardPrefab: Prefab = null;\r\n    @property(Node) tableArea: Node = null;\r\n    @property(Node) undoButton: Node = null;\r\n\r\n    // 资源引用\r\n    @property([SpriteFrame]) bigRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) bigBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) suitSprites: SpriteFrame[] = [];\r\n\r\n    private historyStack: CardMoveRecord[] = [];\r\n\r\n    async onLoad() {\r\n        await this.initializeConfig();\r\n        await this.loadLevel();\r\n        this.createCardsFromData();\r\n        this.setupUndoButton();\r\n    }\r\n\r\n    private async initializeConfig(): Promise<void> {\r\n        await GameConfig.instance.initialize();\r\n    }\r\n\r\n    private async loadLevel(): Promise<void> {\r\n        const success = await DataManager.instance.loadLevel(1);\r\n        if (!success) {\r\n            console.error('加载关卡失败');\r\n        } else {\r\n            DataManager.instance.gameModel.updateTopAndReserveCards();\r\n        }\r\n    }\r\n\r\n    // 设置回退按钮\r\n    private setupUndoButton(): void {\r\n        if (!this.undoButton) {\r\n            console.warn('回退按钮未设置');\r\n            return;\r\n        }\r\n        this.undoButton.on(Node.EventType.TOUCH_END, () => {\r\n            this.undoLastMove();\r\n        }, this);\r\n    }\r\n\r\n    // 创建所有卡牌视图\r\n    private createCardsFromData(): void {\r\n        if (!this.cardPrefab) return;\r\n        this.tableArea.removeAllChildren();\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        DataManager.instance.gameModel.tableCards.forEach((cardData) => {\r\n            this.createTableCard(cardData, layoutConfig);\r\n        });\r\n\r\n        const totalHandCards = DataManager.instance.gameModel.handCards.size;\r\n        DataManager.instance.gameModel.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n\r\n        const handCards = Array.from(DataManager.instance.gameModel.handCards.values());\r\n        if (handCards.length > 0) {\r\n            DataManager.instance.gameModel.topCard = handCards[handCards.length - 1];\r\n        }\r\n    }\r\n\r\n    // 创建桌面牌\r\n    private createTableCard(cardData: CardModel, layoutConfig: any): void {\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n        (cardNode as any).cardId = cardData.id;\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n        this.setupTableCardPosition(cardNode, cardData, layoutConfig);\r\n\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            cardView.setClickCallback((view: CardView) => {\r\n                this.onTableCardClick(cardNode);\r\n            });\r\n        }\r\n    }\r\n\r\n    // 设置桌面牌位置\r\n    private setupTableCardPosition(cardNode: Node, cardData: CardModel, layoutConfig: any): void {\r\n        const relativePos = CardUtils.convertAbsoluteToRelativeForTable(\r\n            cardData.position.x,\r\n            cardData.position.y\r\n        );\r\n        cardNode.setPosition(relativePos.x, relativePos.y, 0);\r\n        cardNode.setSiblingIndex(cardData.zIndex);\r\n    }\r\n\r\n    // 创建手牌\r\n    private createHandCard(cardData: CardModel, layoutConfig: any, totalCards: number): void {\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n        (cardNode as any).cardId = cardData.id;\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n        this.setupHandCardPosition(cardNode, cardData, layoutConfig, totalCards);\r\n\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            cardView.setClickCallback((view: CardView) => {\r\n                this.onHandCardClick(cardNode);\r\n            });\r\n        }\r\n    }\r\n\r\n    // 设置手牌位置\r\n    private setupHandCardPosition(cardNode: Node, cardData: CardModel, layoutConfig: any, totalCards: number): void {\r\n        const handConf = layoutConfig?.handLayout || {};\r\n        const stackX = handConf.stackStartX ?? -350;\r\n        const startY = handConf.stackStartY ?? 0;\r\n        const spacingX = handConf.stackSpacingX ?? 100;\r\n        const separateX = handConf.separateCardX ?? 200;\r\n        const separateY = handConf.separateCardY ?? startY;\r\n\r\n        const index = Array.from(DataManager.instance.gameModel.handCards.values()).indexOf(cardData);\r\n        let posX = 0, posY = startY, zIndex = index;\r\n\r\n        if (index === totalCards - 1) {\r\n            posX = separateX;\r\n            posY = separateY;\r\n            zIndex = 100;\r\n        } else {\r\n            posX = stackX + (index * spacingX);\r\n            posY = startY;\r\n            zIndex = index;\r\n        }\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(zIndex);\r\n        cardData.updatePosition(posX, posY);\r\n        cardData.zIndex = zIndex;\r\n    }\r\n\r\n    // 设置卡牌显示\r\n    private setupCardDisplay(cardNode: Node, cardData: CardModel): void {\r\n        const config = cardData.config;\r\n        const isRed = CardUtils.isRedSuit(config.CardSuit);\r\n        const cardView = cardNode.getComponent(CardView);\r\n\r\n        if (cardView) {\r\n            const index = Array.from(\r\n                cardData.currentArea === 'table' \r\n                    ? DataManager.instance.gameModel.tableCards.values()\r\n                    : DataManager.instance.gameModel.handCards.values()\r\n            ).indexOf(cardData);\r\n            cardView.init(cardData, index, cardData.currentArea);\r\n        }\r\n\r\n        const setSprite = (name: string, spriteFrame: SpriteFrame) => {\r\n            const node = cardNode.getChildByName(name);\r\n            if (node) {\r\n                const sp = node.getComponent(Sprite);\r\n                if (sp) {\r\n                    sp.spriteFrame = spriteFrame;\r\n                    sp.color = Color.WHITE;\r\n                }\r\n            }\r\n        };\r\n\r\n        setSprite('bigNum', this.getNumberSprite(config.CardFace, true, isRed));\r\n        setSprite('smallNum', this.getNumberSprite(config.CardFace, false, isRed));\r\n\r\n        if (config.CardSuit >= 0 && config.CardSuit < this.suitSprites.length) {\r\n            setSprite('suit', this.suitSprites[config.CardSuit]);\r\n        }\r\n\r\n        cardNode.name = `${cardData.currentArea}_${CardUtils.getCardName(config.CardSuit, config.CardFace)}`;\r\n    }\r\n\r\n    private getNumberSprite(face: number, isBig: boolean, isRed: boolean): SpriteFrame | null {\r\n        if (face < 0 || face > 12) return null;\r\n        const arr = isBig\r\n            ? (isRed ? this.bigRedNumbers : this.bigBlackNumbers)\r\n            : (isRed ? this.smallRedNumbers : this.smallBlackNumbers);\r\n        return arr[face] || null;\r\n    }\r\n\r\n    // 点击事件处理\r\n    public onTableCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'table') return;\r\n        this.handleCardClick(cardNode, cardData);\r\n    }\r\n\r\n    public onHandCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'hand') return;\r\n        this.handleCardClick(cardNode, cardData);\r\n    }\r\n\r\n    private handleCardClick(cardNode: Node, cardData: CardModel): void {\r\n        const currentTopCard = DataManager.instance.gameModel.topCard;\r\n        const reserveCards = DataManager.instance.gameModel.reserveCards;\r\n\r\n        if (cardData.currentArea === 'hand' && cardData !== currentTopCard) {\r\n            const cardIndex = reserveCards.indexOf(cardData);\r\n            if (cardIndex !== reserveCards.length - 1) return;\r\n            \r\n            DataManager.instance.gameModel.topCard = cardData;\r\n            const currentReserveCards = DataManager.instance.gameModel.reserveCards;\r\n            const cardIndex2 = currentReserveCards.indexOf(cardData);\r\n            if (cardIndex2 !== -1) {\r\n                currentReserveCards.splice(cardIndex2, 1);\r\n            }\r\n        }\r\n\r\n        if (cardData.currentArea !== 'hand' && currentTopCard) {\r\n            if (!CardService.canMoveToCard(cardData, currentTopCard)) return;\r\n        }\r\n\r\n        const targetPosition = this.calculateTargetPosition(cardData);\r\n        this.saveCardMoveRecord(cardData, targetPosition);\r\n\r\n        if (cardData.currentArea === 'table') {\r\n            DataManager.instance.gameModel.topCard = cardData;\r\n        }\r\n\r\n        cardData.updatePosition(targetPosition.x, targetPosition.y);\r\n        cardNode.setSiblingIndex(100);\r\n        cardData.zIndex = 100;\r\n\r\n        tween(cardNode)\r\n            .to(0.3, { position: new Vec3(targetPosition.x, targetPosition.y, 0) })\r\n            .start();\r\n    }\r\n\r\n    // 计算目标位置\r\n    private calculateTargetPosition(cardData: CardModel): { x: number, y: number } {\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n        const handConf = layoutConfig?.handLayout;\r\n        const handCards = Array.from(DataManager.instance.gameModel.handCards.values());\r\n        const lastHandCard = handCards[handCards.length - 1];\r\n\r\n        if (lastHandCard) {\r\n            const children = this.tableArea.children;\r\n            for (let i = 0; i < children.length; i++) {\r\n                const child = children[i];\r\n                const cardId = (child as any).cardId;\r\n                if (cardId === lastHandCard.id) {\r\n                    const position = child.getPosition();\r\n                    return { x: position.x, y: position.y };\r\n                }\r\n            }\r\n        }\r\n\r\n        return {\r\n            x: handConf?.separateCardX ?? 200,\r\n            y: handConf?.separateCardY ?? 0\r\n        };\r\n    }\r\n\r\n    // 保存卡牌移动记录\r\n    private saveCardMoveRecord(cardData: CardModel, targetPosition: { x: number, y: number }): void {\r\n        const children = this.tableArea.children;\r\n        let cardNode: Node | null = null;\r\n        \r\n        for (let i = 0; i < children.length; i++) {\r\n            const child = children[i];\r\n            const cardId = (child as any).cardId;\r\n            if (cardId === cardData.id) {\r\n                cardNode = child;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (!cardNode) return;\r\n\r\n        const currentPosition = cardNode.getPosition();\r\n        const currentTopCard = DataManager.instance.gameModel.topCard;\r\n        const reserveCards = DataManager.instance.gameModel.reserveCards;\r\n        const previousReserveCardIds = reserveCards.map(card => card.id);\r\n\r\n        this.historyStack.push({\r\n            cardId: cardData.id,\r\n            fromPosition: { x: currentPosition.x, y: currentPosition.y },\r\n            toPosition: { x: targetPosition.x, y: targetPosition.y },\r\n            fromArea: cardData.currentArea,\r\n            toArea: cardData.currentArea,\r\n            zIndex: cardData.zIndex,\r\n            previousTopCardId: currentTopCard ? currentTopCard.id : null,\r\n            previousReserveCardIds: previousReserveCardIds\r\n        });\r\n    }\r\n\r\n    // 回退最后一次移动\r\n    private undoLastMove(): void {\r\n        if (this.historyStack.length === 0) return;\r\n        const lastRecord = this.historyStack.pop();\r\n        if (!lastRecord) return;\r\n\r\n        const children = this.tableArea.children;\r\n        for (let i = 0; i < children.length; i++) {\r\n            const child = children[i];\r\n            const cardId = (child as any).cardId;\r\n            if (cardId === lastRecord.cardId) {\r\n                tween(child)\r\n                    .to(0.3, { position: new Vec3(lastRecord.fromPosition.x, lastRecord.fromPosition.y, 0) })\r\n                    .call(() => {\r\n                        if (lastRecord.previousTopCardId) {\r\n                            const previousTopCard = DataManager.instance.gameModel.getCardById(lastRecord.previousTopCardId);\r\n                            if (previousTopCard) {\r\n                                DataManager.instance.gameModel.topCard = previousTopCard;\r\n                            }\r\n                        } else {\r\n                            DataManager.instance.gameModel.topCard = null;\r\n                        }\r\n                        \r\n                        if (lastRecord.previousReserveCardIds && lastRecord.previousReserveCardIds.length > 0) {\r\n                            const restoredReserveCards: CardModel[] = [];\r\n                            lastRecord.previousReserveCardIds.forEach(cardId => {\r\n                                const card = DataManager.instance.gameModel.getCardById(cardId);\r\n                                if (card) {\r\n                                    restoredReserveCards.push(card);\r\n                                }\r\n                            });\r\n                            DataManager.instance.gameModel.reserveCards = restoredReserveCards;\r\n                        } else {\r\n                            DataManager.instance.gameModel.reserveCards = [];\r\n                        }\r\n                    })\r\n                    .start();\r\n\r\n                const cardData = this.getCardDataFromNode(child);\r\n                if (cardData) {\r\n                    cardData.updatePosition(lastRecord.fromPosition.x, lastRecord.fromPosition.y);\r\n                    cardData.zIndex = lastRecord.zIndex;\r\n                }\r\n                child.setSiblingIndex(lastRecord.zIndex);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    // 撤销操作\r\n    public onUndoClick(): void {\r\n        const success = DataManager.instance.undo();\r\n        if (success) {\r\n            this.refreshAllCardsDisplay();\r\n        }\r\n    }\r\n\r\n    // 刷新所有卡牌显示\r\n    private refreshAllCardsDisplay(): void {\r\n        this.createCardsFromData();\r\n    }\r\n\r\n    // 从节点获取卡牌数据\r\n    private getCardDataFromNode(cardNode: Node): CardModel | undefined {\r\n        const cardId = (cardNode as any).cardId;\r\n        if (!cardId) return undefined;\r\n        return DataManager.instance.gameModel.getCardById(cardId);\r\n    }\r\n}\r\n"]}