{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/controllers/LevelController.ts"],"names":["_decorator","Color","Component","instantiate","Node","Prefab","Sprite","SpriteFrame","tween","Vec3","GameConfig","DataManager","CardUtils","CardView","ccclass","property","LevelController","onLoad","initializeConfig","loadLevel","createCardsFromData","instance","initialize","success","console","error","cardPrefab","tableArea","removeAllChildren","handArea","layoutConfig","gameModel","tableCards","forEach","cardData","createTableCard","totalHandCards","handCards","size","createHandCard","log","cardNode","addChild","cardId","id","setupCardDisplay","cardView","getComponent","setClickCallback","view","getCardData","onTableCardClick","posX","position","x","posY","y","setPosition","setSiblingIndex","zIndex","totalCards","setupHandCardPosition","onHandCardClick","handConf","handLayout","stackX","stackStartX","startY","stackStartY","spacingX","horizontalSpacing","stackSpacingX","separateX","separateCardX","separateY","separateCardY","index","Array","from","values","indexOf","config","isRed","isRedSuit","CardSuit","currentArea","init","setSprite","name","spriteFrame","node","getChildByName","sp","color","WHITE","getNumberSprite","CardFace","suitSprites","length","getCardName","face","isBig","arr","bigRedNumbers","bigBlackNumbers","smallRedNumbers","smallBlackNumbers","getCardDataFromNode","setParent","updateArea","moveCardToLastHandPosition","isLastCard","targetX","targetY","suitName","getSuitName","faceName","getFaceName","to","start","updatePosition","suit","suits","faces","onUndoClick","undo","refreshAllCardsDisplay","undefined","getCardById","refreshCardDisplay","removeLastHandCardView","lastCard","getLastHandCard","lastCardNode","getChildByPath","removeFromParent","refreshHandCardsDisplay"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,I,OAAAA,I;;AACrFC,MAAAA,U,iBAAAA,U;;AACAC,MAAAA,W,iBAAAA,W;;AAEAC,MAAAA,S,iBAAAA,S;;AACFC,MAAAA,Q;;;;;;;;;OAED;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBf,U;;yBAGTgB,e,WADpBF,OAAO,CAAC,iBAAD,C,UAGHC,QAAQ,CAACV,MAAD,C,UACRU,QAAQ,CAACX,IAAD,C,UACRW,QAAQ,CAACX,IAAD,C,UAGRW,QAAQ,CAAC,CAACR,WAAD,CAAD,C,UACRQ,QAAQ,CAAC,CAACR,WAAD,CAAD,C,UACRQ,QAAQ,CAAC,CAACR,WAAD,CAAD,C,UACRQ,QAAQ,CAAC,CAACR,WAAD,CAAD,C,UACRQ,QAAQ,CAAC,CAACR,WAAD,CAAD,C,2BAZb,MACqBS,eADrB,SAC6Cd,SAD7C,CACuD;AAAA;AAAA;;AACnD;AADmD;;AAAA;;AAAA;;AAMnD;AANmD;;AAAA;;AAAA;;AAAA;;AAAA;AAAA;;AAavC,cAANe,MAAM,GAAG;AACX;AACA,gBAAM,KAAKC,gBAAL,EAAN,CAFW,CAGX;;AACA,gBAAM,KAAKC,SAAL,EAAN,CAJW,CAKX;;AACA,eAAKC,mBAAL;AACH;;AAE6B,cAAhBF,gBAAgB,GAAkB;AAC5C,gBAAM;AAAA;AAAA,wCAAWG,QAAX,CAAoBC,UAApB,EAAN;AACH;;AAEsB,cAATH,SAAS,GAAkB;AACrC,gBAAMI,OAAO,GAAG,MAAM;AAAA;AAAA,0CAAYF,QAAZ,CAAqBF,SAArB,CAA+B,CAA/B,CAAtB;;AACA,cAAI,CAACI,OAAL,EAAc;AACVC,YAAAA,OAAO,CAACC,KAAR,CAAc,QAAd;AACH;AACJ;;AAEOL,QAAAA,mBAAmB,GAAS;AAChC,cAAI,CAAC,KAAKM,UAAV,EAAsB;AAEtB,eAAKC,SAAL,CAAeC,iBAAf;AACA,eAAKC,QAAL,CAAcD,iBAAd;AAEA,gBAAME,YAAY,GAAG;AAAA;AAAA,wCAAWT,QAAX,CAAoBS,YAAzC,CANgC,CAQhC;;AACA;AAAA;AAAA,0CAAYT,QAAZ,CAAqBU,SAArB,CAA+BC,UAA/B,CAA0CC,OAA1C,CAAmDC,QAAD,IAAc;AAC5D,iBAAKC,eAAL,CAAqBD,QAArB,EAA+BJ,YAA/B;AACH,WAFD,EATgC,CAahC;;AACA,gBAAMM,cAAc,GAAG;AAAA;AAAA,0CAAYf,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyCC,IAAhE;AACA;AAAA;AAAA,0CAAYjB,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyCJ,OAAzC,CAAkDC,QAAD,IAAc;AAC3D,iBAAKK,cAAL,CAAoBL,QAApB,EAA8BJ,YAA9B,EAA4CM,cAA5C;AACH,WAFD;AAGH,SAnDkD,CAqDnD;;;AACQD,QAAAA,eAAe,CAACD,QAAD,EAAsBJ,YAAtB,EAA+C;AAClEN,UAAAA,OAAO,CAACgB,GAAR,CAAY,QAAZ,EAAsBN,QAAtB;AACA,gBAAMO,QAAQ,GAAGtC,WAAW,CAAC,KAAKuB,UAAN,CAA5B;AACA,eAAKC,SAAL,CAAee,QAAf,CAAwBD,QAAxB,EAHkE,CAKlE;;AACCA,UAAAA,QAAD,CAAkBE,MAAlB,GAA2BT,QAAQ,CAACU,EAApC;AACApB,UAAAA,OAAO,CAACgB,GAAR,CAAY,kBAAZ,EAAgCN,QAAQ,CAACU,EAAzC;AAEA,eAAKC,gBAAL,CAAsBJ,QAAtB,EAAgCP,QAAhC,EATkE,CAWlE;;AACA,gBAAMY,QAAQ,GAAGL,QAAQ,CAACM,YAAT;AAAA;AAAA,mCAAjB;;AACA,cAAID,QAAJ,EAAc;AACVA,YAAAA,QAAQ,CAACE,gBAAT,CAA2BC,IAAD,IAAoB;AAC1CzB,cAAAA,OAAO,CAACgB,GAAR,CAAY,UAAZ,EAAwBS,IAAI,CAACC,WAAL,EAAxB;AACA,mBAAKC,gBAAL,CAAsBV,QAAtB;AACH,aAHD;AAIAjB,YAAAA,OAAO,CAACgB,GAAR,CAAY,aAAZ;AACH,WAND,MAMO;AACHhB,YAAAA,OAAO,CAACC,KAAR,CAAc,gBAAd;AACH,WArBiE,CAuBlE;;;AACA,cAAI2B,IAAI,GAAGlB,QAAQ,CAACmB,QAAT,CAAkBC,CAA7B;AACA,cAAIC,IAAI,GAAGrB,QAAQ,CAACmB,QAAT,CAAkBG,CAA7B,CAzBkE,CA2BlE;;AACAJ,UAAAA,IAAI,GAAGA,IAAI,GAAG,GAAd;AACAG,UAAAA,IAAI,GAAGA,IAAI,GAAG,GAAP,GAAa,GAApB;AAEAd,UAAAA,QAAQ,CAACgB,WAAT,CAAqBL,IAArB,EAA2BG,IAA3B,EAAiC,CAAjC;AACAd,UAAAA,QAAQ,CAACiB,eAAT,CAAyBxB,QAAQ,CAACyB,MAAlC,EAhCkE,CAgCvB;AAC9C,SAvFkD,CAyFnD;;;AACQpB,QAAAA,cAAc,CAACL,QAAD,EAAsBJ,YAAtB,EAAyC8B,UAAzC,EAAmE;AACrFpC,UAAAA,OAAO,CAACgB,GAAR,CAAY,OAAZ,EAAqBN,QAArB;AACA,gBAAMO,QAAQ,GAAGtC,WAAW,CAAC,KAAKuB,UAAN,CAA5B;AACA,eAAKG,QAAL,CAAca,QAAd,CAAuBD,QAAvB,EAHqF,CAKrF;;AACCA,UAAAA,QAAD,CAAkBE,MAAlB,GAA2BT,QAAQ,CAACU,EAApC;AACApB,UAAAA,OAAO,CAACgB,GAAR,CAAY,kBAAZ,EAAgCN,QAAQ,CAACU,EAAzC;AAEA,eAAKC,gBAAL,CAAsBJ,QAAtB,EAAgCP,QAAhC;AACA,eAAK2B,qBAAL,CAA2BpB,QAA3B,EAAqCP,QAArC,EAA+CJ,YAA/C,EAA6D8B,UAA7D,EAVqF,CAYrF;;AACA,gBAAMd,QAAQ,GAAGL,QAAQ,CAACM,YAAT;AAAA;AAAA,mCAAjB;;AACA,cAAID,QAAJ,EAAc;AACVA,YAAAA,QAAQ,CAACE,gBAAT,CAA2BC,IAAD,IAAoB;AAC1CzB,cAAAA,OAAO,CAACgB,GAAR,CAAY,QAAZ,EAAsBS,IAAI,CAACC,WAAL,EAAtB;AACA,mBAAKY,eAAL,CAAqBrB,QAArB;AACH,aAHD;AAIAjB,YAAAA,OAAO,CAACgB,GAAR,CAAY,WAAZ;AACH,WAND,MAMO;AACHhB,YAAAA,OAAO,CAACC,KAAR,CAAc,gBAAd;AACH;AACJ,SAjHkD,CAmHnD;;;AACQoC,QAAAA,qBAAqB,CACzBpB,QADyB,EAEzBP,QAFyB,EAGzBJ,YAHyB,EAIzB8B,UAJyB,EAKrB;AAAA;;AACJ;AACApC,UAAAA,OAAO,CAACgB,GAAR,CAAY,OAAZ,EAAqBV,YAArB,EAFI,CAGJ;;AACA,gBAAMiC,QAAQ,GAAG,CAAAjC,YAAY,QAAZ,YAAAA,YAAY,CAAEkC,UAAd,KAA4B,EAA7C,CAJI,CAMJ;;AACA,gBAAMC,MAAM,oCAAGF,QAAQ,CAACG,WAAZ,oCAA2BH,QAAQ,CAACG,WAApC,mBAAmD,CAAC,GAAhE;AACA,gBAAMC,MAAM,4BAAGJ,QAAQ,CAACK,WAAZ,oCAA2B,CAAvC;AACA,gBAAMC,QAAQ,qCAAGN,QAAQ,CAACO,iBAAZ,oCAAiCP,QAAQ,CAACQ,aAA1C,oBAA2D,GAAzE,CATI,CAWJ;;AACA,gBAAMC,SAAS,qCAAGT,QAAQ,CAACU,aAAZ,oCAA6BV,QAAQ,CAACU,aAAtC,oBAAuD,GAAtE;AACA,gBAAMC,SAAS,sCAAGX,QAAQ,CAACY,aAAZ,qCAA6BZ,QAAQ,CAACY,aAAtC,oBAAuDR,MAAtE,CAbI,CAeJ;;AACA,gBAAMS,KAAK,GAAGC,KAAK,CAACC,IAAN,CAAW;AAAA;AAAA,0CAAYzD,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyC0C,MAAzC,EAAX,EAA8DC,OAA9D,CAAsE9C,QAAtE,CAAd;AAEA,cAAIkB,IAAI,GAAG,CAAX;AACA,cAAIG,IAAI,GAAGY,MAAX;AACA,cAAIR,MAAM,GAAGiB,KAAb,CApBI,CAsBJ;;AACA,cAAIA,KAAK,KAAKhB,UAAU,GAAG,CAA3B,EAA8B;AAC1B;AACAR,YAAAA,IAAI,GAAGoB,SAAP;AACAjB,YAAAA,IAAI,GAAGmB,SAAP;AACAf,YAAAA,MAAM,GAAG,GAAT,CAJ0B,CAIZ;AACjB,WALD,MAKO;AACH;AACA;AACAP,YAAAA,IAAI,GAAGa,MAAM,GAAIW,KAAK,GAAGP,QAAzB;AACAd,YAAAA,IAAI,GAAGY,MAAP;AACAR,YAAAA,MAAM,GAAGiB,KAAT,CALG,CAKa;AACnB;;AAEDnC,UAAAA,QAAQ,CAACgB,WAAT,CAAqBL,IAArB,EAA2BG,IAA3B,EAAiC,CAAjC;AACAd,UAAAA,QAAQ,CAACiB,eAAT,CAAyBC,MAAzB;AAEAnC,UAAAA,OAAO,CAACgB,GAAR,CAAa,MAAKoC,KAAM,SAAQxB,IAAK,KAAIG,IAAK,GAA9C;AACH,SAjKkD,CAmKnD;;;AACQV,QAAAA,gBAAgB,CAACJ,QAAD,EAAiBP,QAAjB,EAA4C;AAChE,gBAAM+C,MAAM,GAAG/C,QAAQ,CAAC+C,MAAxB;AACA,gBAAMC,KAAK,GAAG;AAAA;AAAA,sCAAUC,SAAV,CAAoBF,MAAM,CAACG,QAA3B,CAAd,CAFgE,CAIhE;;AACA,gBAAMtC,QAAQ,GAAGL,QAAQ,CAACM,YAAT;AAAA;AAAA,mCAAjB;;AACA,cAAID,QAAJ,EAAc;AACV,kBAAM8B,KAAK,GAAGC,KAAK,CAACC,IAAN,CACV5C,QAAQ,CAACmD,WAAT,KAAyB,OAAzB,GACM;AAAA;AAAA,4CAAYhE,QAAZ,CAAqBU,SAArB,CAA+BC,UAA/B,CAA0C+C,MAA1C,EADN,GAEM;AAAA;AAAA,4CAAY1D,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyC0C,MAAzC,EAHI,EAIZC,OAJY,CAIJ9C,QAJI,CAAd;AAKAY,YAAAA,QAAQ,CAACwC,IAAT,CAAcpD,QAAd,EAAwB0C,KAAxB,EAA+B1C,QAAQ,CAACmD,WAAxC;AACA7D,YAAAA,OAAO,CAACgB,GAAR,CAAY,gBAAZ,EAA8BN,QAA9B;AACH,WAd+D,CAgBhE;;;AACA,gBAAMqD,SAAS,GAAG,CAACC,IAAD,EAAeC,WAAf,KAA4C;AAC1D,kBAAMC,IAAI,GAAGjD,QAAQ,CAACkD,cAAT,CAAwBH,IAAxB,CAAb;;AACA,gBAAIE,IAAJ,EAAU;AACN,oBAAME,EAAE,GAAGF,IAAI,CAAC3C,YAAL,CAAkBzC,MAAlB,CAAX;;AACA,kBAAIsF,EAAJ,EAAQ;AACJA,gBAAAA,EAAE,CAACH,WAAH,GAAiBA,WAAjB;AACAG,gBAAAA,EAAE,CAACC,KAAH,GAAW5F,KAAK,CAAC6F,KAAjB;AACH;AACJ;AACJ,WATD;;AAWAP,UAAAA,SAAS,CAAC,QAAD,EAAW,KAAKQ,eAAL,CAAqBd,MAAM,CAACe,QAA5B,EAAsC,IAAtC,EAA4Cd,KAA5C,CAAX,CAAT;AACAK,UAAAA,SAAS,CAAC,UAAD,EAAa,KAAKQ,eAAL,CAAqBd,MAAM,CAACe,QAA5B,EAAsC,KAAtC,EAA6Cd,KAA7C,CAAb,CAAT;;AAEA,cAAID,MAAM,CAACG,QAAP,IAAmB,CAAnB,IAAwBH,MAAM,CAACG,QAAP,GAAkB,KAAKa,WAAL,CAAiBC,MAA/D,EAAuE;AACnEX,YAAAA,SAAS,CAAC,MAAD,EAAS,KAAKU,WAAL,CAAiBhB,MAAM,CAACG,QAAxB,CAAT,CAAT;AACH;;AAED3C,UAAAA,QAAQ,CAAC+C,IAAT,GAAiB,GAAEtD,QAAQ,CAACmD,WAAY,IAAG;AAAA;AAAA,sCAAUc,WAAV,CAAsBlB,MAAM,CAACG,QAA7B,EAAuCH,MAAM,CAACe,QAA9C,CAAwD,EAAnG;AACH;;AAEOD,QAAAA,eAAe,CAACK,IAAD,EAAeC,KAAf,EAA+BnB,KAA/B,EAAmE;AACtF,cAAIkB,IAAI,GAAG,CAAP,IAAYA,IAAI,GAAG,EAAvB,EAA2B,OAAO,IAAP;AAC3B,gBAAME,GAAG,GAAGD,KAAK,GACVnB,KAAK,GAAG,KAAKqB,aAAR,GAAwB,KAAKC,eADxB,GAEVtB,KAAK,GAAG,KAAKuB,eAAR,GAA0B,KAAKC,iBAF3C;AAGA,iBAAOJ,GAAG,CAACF,IAAD,CAAH,IAAa,IAApB;AACH,SAhNkD,CAkNnD;;AAEA;AACJ;AACA;AACA;;;AACWjD,QAAAA,gBAAgB,CAACV,QAAD,EAAuB;AAC1C,gBAAMP,QAAQ,GAAG,KAAKyE,mBAAL,CAAyBlE,QAAzB,CAAjB;AACA,cAAI,CAACP,QAAD,IAAaA,QAAQ,CAACmD,WAAT,KAAyB,OAA1C,EAAmD,OAFT,CAI1C;;AACA5C,UAAAA,QAAQ,CAACmE,SAAT,CAAmB,KAAK/E,QAAxB,EAL0C,CAO1C;;AACAK,UAAAA,QAAQ,CAAC2E,UAAT,CAAoB,MAApB,EAR0C,CAU1C;;AACA,eAAKC,0BAAL,CAAgCrE,QAAhC,EAA0CP,QAA1C;AACH;AAED;AACJ;AACA;AACA;;;AACW4B,QAAAA,eAAe,CAACrB,QAAD,EAAuB;AAAA;;AACzC,gBAAMP,QAAQ,GAAG,KAAKyE,mBAAL,CAAyBlE,QAAzB,CAAjB;AACA,cAAI,CAACP,QAAD,IAAaA,QAAQ,CAACmD,WAAT,KAAyB,MAA1C,EAAkD,OAFT,CAIzC;;AACA,gBAAMhD,SAAS,GAAGwC,KAAK,CAACC,IAAN,CAAW;AAAA;AAAA,0CAAYzD,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyC0C,MAAzC,EAAX,CAAlB;AACA,gBAAMgC,UAAU,GAAG,eAAA1E,SAAS,CAACA,SAAS,CAAC6D,MAAV,GAAmB,CAApB,CAAT,gCAAiCtD,EAAjC,MAAwCV,QAAQ,CAACU,EAApE,CANyC,CAQzC;;AACA,cAAI,CAACmE,UAAL,EAAiB;AACb,iBAAKD,0BAAL,CAAgCrE,QAAhC,EAA0CP,QAA1C;AACH;AACJ;AAED;AACJ;AACA;AACA;AACA;;;AACY4E,QAAAA,0BAA0B,CAACrE,QAAD,EAAiBP,QAAjB,EAA4C;AAAA;;AAC1E,gBAAMJ,YAAY,GAAG;AAAA;AAAA,wCAAWT,QAAX,CAAoBS,YAAzC;AACA,gBAAMiC,QAAQ,GAAGjC,YAAH,oBAAGA,YAAY,CAAEkC,UAA/B,CAF0E,CAI1E;;AACA,gBAAMgD,OAAO,6BAAGjD,QAAH,oBAAGA,QAAQ,CAAEU,aAAb,qCAA8B,GAA3C;AACA,gBAAMwC,OAAO,6BAAGlD,QAAH,oBAAGA,QAAQ,CAAEY,aAAb,qCAA8B,CAA3C,CAN0E,CAQ1E;;AACA,gBAAMuC,QAAQ,GAAG,KAAKC,WAAL,CAAiBjF,QAAQ,CAAC+C,MAAT,CAAgBG,QAAjC,CAAjB;AACA,gBAAMgC,QAAQ,GAAG,KAAKC,WAAL,CAAiBnF,QAAQ,CAAC+C,MAAT,CAAgBe,QAAjC,CAAjB;AACAxE,UAAAA,OAAO,CAACgB,GAAR,CAAa,SAAQ0E,QAAS,GAAEE,QAAS,EAAzC;AACA5F,UAAAA,OAAO,CAACgB,GAAR,CAAa,YAAWwE,OAAQ,KAAIC,OAAQ,GAA5C,EAZ0E,CAc1E;;AACAzG,UAAAA,KAAK,CAACiC,QAAD,CAAL,CACK6E,EADL,CACQ,GADR,EACa;AAAEjE,YAAAA,QAAQ,EAAE,IAAI5C,IAAJ,CAASuG,OAAT,EAAkBC,OAAlB,EAA2B,CAA3B;AAAZ,WADb,EAEKM,KAFL,GAf0E,CAmB1E;;AACArF,UAAAA,QAAQ,CAACsF,cAAT,CAAwBR,OAAxB,EAAiCC,OAAjC,EApB0E,CAsB1E;;AACAxE,UAAAA,QAAQ,CAACiB,eAAT,CAAyB,GAAzB;AACAxB,UAAAA,QAAQ,CAACyB,MAAT,GAAkB,GAAlB;AACH;AAED;AACJ;AACA;;;AACYwD,QAAAA,WAAW,CAACM,IAAD,EAAuB;AACtC,gBAAMC,KAAK,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,GAAhB,CAAd;AACA,iBAAOA,KAAK,CAACD,IAAD,CAAL,IAAe,GAAtB;AACH;AAED;AACJ;AACA;;;AACYJ,QAAAA,WAAW,CAACjB,IAAD,EAAuB;AACtC,gBAAMuB,KAAK,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,GAAhB,EAAqB,GAArB,EAA0B,GAA1B,EAA+B,GAA/B,EAAoC,GAApC,EAAyC,GAAzC,EAA8C,IAA9C,EAAoD,GAApD,EAAyD,GAAzD,EAA8D,GAA9D,CAAd;AACA,iBAAOA,KAAK,CAACvB,IAAD,CAAL,IAAe,GAAtB;AACH;AAED;AACJ;AACA;;;AACWwB,QAAAA,WAAW,GAAS;AACvB,gBAAMrG,OAAO,GAAG;AAAA;AAAA,0CAAYF,QAAZ,CAAqBwG,IAArB,EAAhB;;AACA,cAAItG,OAAJ,EAAa;AACTC,YAAAA,OAAO,CAACgB,GAAR,CAAY,OAAZ,EADS,CAET;;AACA,iBAAKsF,sBAAL;AACH,WAJD,MAIO;AACHtG,YAAAA,OAAO,CAACgB,GAAR,CAAY,MAAZ;AACH;AACJ;AAED;AACJ;AACA;;;AACYmE,QAAAA,mBAAmB,CAAClE,QAAD,EAAwC;AAC/D;AACAjB,UAAAA,OAAO,CAACgB,GAAR,CAAY,gCAAZ;AACAhB,UAAAA,OAAO,CAACgB,GAAR,CAAY,OAAZ,EAAqBC,QAAQ,CAAC+C,IAA9B;AACAhE,UAAAA,OAAO,CAACgB,GAAR,CAAY,SAAZ,EAAuBC,QAAvB,EAJ+D,CAM/D;;AACA,gBAAME,MAAM,GAAIF,QAAD,CAAkBE,MAAjC;AACAnB,UAAAA,OAAO,CAACgB,GAAR,CAAY,iBAAZ,EAA+BG,MAA/B;;AAEA,cAAI,CAACA,MAAL,EAAa;AACTnB,YAAAA,OAAO,CAACgB,GAAR,CAAY,eAAZ;AACA,mBAAOuF,SAAP;AACH;;AAED,gBAAM7F,QAAQ,GAAG;AAAA;AAAA,0CAAYb,QAAZ,CAAqBU,SAArB,CAA+BiG,WAA/B,CAA2CrF,MAA3C,CAAjB;AACAnB,UAAAA,OAAO,CAACgB,GAAR,CAAY,eAAZ,EAA6BN,QAA7B;AAEA,iBAAOA,QAAP;AACH;AAED;AACJ;AACA;;;AACY+F,QAAAA,kBAAkB,CAACxF,QAAD,EAAiBP,QAAjB,EAA4C;AAClE,eAAKW,gBAAL,CAAsBJ,QAAtB,EAAgCP,QAAhC;AACH;AAED;AACJ;AACA;;;AACYgG,QAAAA,sBAAsB,GAAS;AACnC,gBAAMC,QAAQ,GAAG;AAAA;AAAA,0CAAY9G,QAAZ,CAAqBU,SAArB,CAA+BqG,eAA/B,EAAjB;;AACA,cAAID,QAAJ,EAAc;AACV,kBAAME,YAAY,GAAG,KAAKxG,QAAL,CAAcyG,cAAd,CAA6BH,QAAQ,CAACvF,EAAtC,CAArB;;AACA,gBAAIyF,YAAJ,EAAkB;AACdA,cAAAA,YAAY,CAACE,gBAAb;AACH;AACJ;AACJ;AAED;AACJ;AACA;;;AACYC,QAAAA,uBAAuB,GAAS;AACpC,eAAK3G,QAAL,CAAcD,iBAAd;AACA,gBAAMQ,cAAc,GAAG;AAAA;AAAA,0CAAYf,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyCC,IAAhE;AACA,gBAAMR,YAAY,GAAG;AAAA;AAAA,wCAAWT,QAAX,CAAoBS,YAAzC;AAEA;AAAA;AAAA,0CAAYT,QAAZ,CAAqBU,SAArB,CAA+BM,SAA/B,CAAyCJ,OAAzC,CAAkDC,QAAD,IAAc;AAC3D,iBAAKK,cAAL,CAAoBL,QAApB,EAA8BJ,YAA9B,EAA4CM,cAA5C;AACH,WAFD;AAGH;AAED;AACJ;AACA;;;AACY0F,QAAAA,sBAAsB,GAAS;AACnC,eAAK1G,mBAAL;AACH;;AApXkD,O;;;;;iBAEZ,I;;;;;;;iBACN,I;;;;;;;iBACC,I;;;;;;;iBAGsB,E;;;;;;;iBACE,E;;;;;;;iBACA,E;;;;;;;iBACE,E;;;;;;;iBACN,E","sourcesContent":["import { _decorator, Color, Component, instantiate, Node, Prefab, Sprite, SpriteFrame, tween, Vec3 } from 'cc';\r\nimport { GameConfig } from '../configs/GameConfig';\r\nimport { DataManager } from '../managers/DataManager';\r\nimport { CardModel } from '../models/CardModel';\r\nimport { CardUtils } from '../utils/CardUtils';\r\nimport CardView from '../views/CardView';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('LevelController')\r\nexport default class LevelController extends Component {\r\n    // --- 属性定义 ---\r\n    @property(Prefab) cardPrefab: Prefab = null;\r\n    @property(Node) handArea: Node = null;\r\n    @property(Node) tableArea: Node = null;\r\n\r\n    // --- 资源引用 ---\r\n    @property([SpriteFrame]) bigRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) bigBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) suitSprites: SpriteFrame[] = [];\r\n\r\n    async onLoad() {\r\n        // 1. 初始化配置\r\n        await this.initializeConfig();\r\n        // 2. 加载关卡\r\n        await this.loadLevel();\r\n        // 3. 创建卡牌视图\r\n        this.createCardsFromData();\r\n    }\r\n\r\n    private async initializeConfig(): Promise<void> {\r\n        await GameConfig.instance.initialize();\r\n    }\r\n\r\n    private async loadLevel(): Promise<void> {\r\n        const success = await DataManager.instance.loadLevel(1);\r\n        if (!success) {\r\n            console.error('加载关卡失败');\r\n        }\r\n    }\r\n\r\n    private createCardsFromData(): void {\r\n        if (!this.cardPrefab) return;\r\n\r\n        this.tableArea.removeAllChildren();\r\n        this.handArea.removeAllChildren();\r\n\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        // 1. 创建桌面牌\r\n        DataManager.instance.gameModel.tableCards.forEach((cardData) => {\r\n            this.createTableCard(cardData, layoutConfig);\r\n        });\r\n\r\n        // 2. 创建手牌\r\n        const totalHandCards = DataManager.instance.gameModel.handCards.size;\r\n        DataManager.instance.gameModel.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n    }\r\n\r\n    // --- 创建桌面牌 ---\r\n    private createTableCard(cardData: CardModel, layoutConfig: any): void {\r\n        console.log('创建桌面牌:', cardData);\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n\r\n        // 将cardId存储到节点属性上\r\n        (cardNode as any).cardId = cardData.id;\r\n        console.log('已将cardId存储到节点属性:', cardData.id);\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n\r\n        // 设置点击回调\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            cardView.setClickCallback((view: CardView) => {\r\n                console.log('点击了桌面卡牌:', view.getCardData());\r\n                this.onTableCardClick(cardNode);\r\n            });\r\n            console.log('桌面卡牌点击回调已设置');\r\n        } else {\r\n            console.error('未找到CardView组件！');\r\n        }\r\n\r\n        // 使用CardModel中的位置\r\n        let posX = cardData.position.x;\r\n        let posY = cardData.position.y;\r\n\r\n        // 简单的向下微调，防止卡牌超出屏幕上边缘\r\n        posX = posX - 540;\r\n        posY = posY - 960 + 300;\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(cardData.zIndex); // 确保渲染顺序\r\n    }\r\n\r\n    // --- 创建手牌 ---\r\n    private createHandCard(cardData: CardModel, layoutConfig: any, totalCards: number): void {\r\n        console.log('创建手牌:', cardData);\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.handArea.addChild(cardNode);\r\n\r\n        // 将cardId存储到节点属性上\r\n        (cardNode as any).cardId = cardData.id;\r\n        console.log('已将cardId存储到节点属性:', cardData.id);\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n        this.setupHandCardPosition(cardNode, cardData, layoutConfig, totalCards);\r\n\r\n        // 设置点击回调\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            cardView.setClickCallback((view: CardView) => {\r\n                console.log('点击了手牌:', view.getCardData());\r\n                this.onHandCardClick(cardNode);\r\n            });\r\n            console.log('手牌点击回调已设置');\r\n        } else {\r\n            console.error('未找到CardView组件！');\r\n        }\r\n    }\r\n\r\n    // --- 设置手牌位置 ---\r\n    private setupHandCardPosition(\r\n        cardNode: Node,\r\n        cardData: CardModel,\r\n        layoutConfig: any,\r\n        totalCards: number\r\n    ): void {\r\n        // 安全获取配置，如果 layoutConfig 为空，使用后面的默认值 (??) 防止不显示\r\n        console.log('布局配置:', layoutConfig);\r\n        // 这里为了兼容你可能还没改好的 JSON 字段，做了一些兼容处理\r\n        const handConf = layoutConfig?.handLayout || {};\r\n\r\n        // 读取配置参数 (带有默认值，保证绝对能显示出来)\r\n        const stackX = handConf.stackStartX ?? handConf.stackStartX ?? -350;\r\n        const startY = handConf.stackStartY ?? 0;\r\n        const spacingX = handConf.horizontalSpacing ?? handConf.stackSpacingX ?? 100;\r\n\r\n        // 右侧单张的位置\r\n        const separateX = handConf.separateCardX ?? handConf.separateCardX ?? 200;\r\n        const separateY = handConf.separateCardY ?? handConf.separateCardY ?? startY;\r\n\r\n        // 获取当前卡牌的索引\r\n        const index = Array.from(DataManager.instance.gameModel.handCards.values()).indexOf(cardData);\r\n\r\n        let posX = 0;\r\n        let posY = startY;\r\n        let zIndex = index;\r\n\r\n        // --- 核心逻辑：判断是否是最后一张 ---\r\n        if (index === totalCards - 1) {\r\n            // 是最后一张 -> 放在右边固定位置\r\n            posX = separateX;\r\n            posY = separateY;\r\n            zIndex = 100; // 放在最上层\r\n        } else {\r\n            // 是前面的牌 -> 左边堆叠\r\n            // 公式：起始X + (当前索引 * 间距)\r\n            posX = stackX + (index * spacingX);\r\n            posY = startY;\r\n            zIndex = index; // 正常层级\r\n        }\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(zIndex);\r\n\r\n        console.log(`手牌 ${index} 位置: (${posX}, ${posY})`);\r\n    }\r\n\r\n    // --- 通用显示设置 ---\r\n    private setupCardDisplay(cardNode: Node, cardData: CardModel): void {\r\n        const config = cardData.config;\r\n        const isRed = CardUtils.isRedSuit(config.CardSuit);\r\n\r\n        // 初始化CardView\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            const index = Array.from(\r\n                cardData.currentArea === 'table' \r\n                    ? DataManager.instance.gameModel.tableCards.values()\r\n                    : DataManager.instance.gameModel.handCards.values()\r\n            ).indexOf(cardData);\r\n            cardView.init(cardData, index, cardData.currentArea);\r\n            console.log('CardView初始化完成:', cardData);\r\n        }\r\n\r\n        // 辅助函数：安全设置图片\r\n        const setSprite = (name: string, spriteFrame: SpriteFrame) => {\r\n            const node = cardNode.getChildByName(name);\r\n            if (node) {\r\n                const sp = node.getComponent(Sprite);\r\n                if (sp) {\r\n                    sp.spriteFrame = spriteFrame;\r\n                    sp.color = Color.WHITE;\r\n                }\r\n            }\r\n        };\r\n\r\n        setSprite('bigNum', this.getNumberSprite(config.CardFace, true, isRed));\r\n        setSprite('smallNum', this.getNumberSprite(config.CardFace, false, isRed));\r\n\r\n        if (config.CardSuit >= 0 && config.CardSuit < this.suitSprites.length) {\r\n            setSprite('suit', this.suitSprites[config.CardSuit]);\r\n        }\r\n\r\n        cardNode.name = `${cardData.currentArea}_${CardUtils.getCardName(config.CardSuit, config.CardFace)}`;\r\n    }\r\n\r\n    private getNumberSprite(face: number, isBig: boolean, isRed: boolean): SpriteFrame | null {\r\n        if (face < 0 || face > 12) return null;\r\n        const arr = isBig\r\n            ? (isRed ? this.bigRedNumbers : this.bigBlackNumbers)\r\n            : (isRed ? this.smallRedNumbers : this.smallBlackNumbers);\r\n        return arr[face] || null;\r\n    }\r\n\r\n    // --- 游戏操作 ---\r\n\r\n    /**\r\n     * 处理桌面卡牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     */\r\n    public onTableCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'table') return;\r\n\r\n        // 将桌面牌从tableArea移动到handArea\r\n        cardNode.setParent(this.handArea);\r\n\r\n        // 更新卡牌数据\r\n        cardData.updateArea('hand');\r\n\r\n        // 将桌面牌移动到手牌最后一张的位置\r\n        this.moveCardToLastHandPosition(cardNode, cardData);\r\n    }\r\n\r\n    /**\r\n     * 处理手牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     */\r\n    public onHandCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'hand') return;\r\n\r\n        // 检查是否是最后一张\r\n        const handCards = Array.from(DataManager.instance.gameModel.handCards.values());\r\n        const isLastCard = handCards[handCards.length - 1]?.id === cardData.id;\r\n\r\n        // 如果不是最后一张，移动到最后一张的位置\r\n        if (!isLastCard) {\r\n            this.moveCardToLastHandPosition(cardNode, cardData);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 将卡牌移动到手牌最后一张的位置\r\n     * @param cardNode 卡牌节点\r\n     * @param cardData 卡牌数据\r\n     */\r\n    private moveCardToLastHandPosition(cardNode: Node, cardData: CardModel): void {\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n        const handConf = layoutConfig?.handLayout;\r\n\r\n        // 获取最后一张牌的位置配置（与setupHandCardPosition保持一致）\r\n        const targetX = handConf?.separateCardX ?? 200;\r\n        const targetY = handConf?.separateCardY ?? 0;\r\n\r\n        // 打印卡牌信息和目标位置\r\n        const suitName = this.getSuitName(cardData.config.CardSuit);\r\n        const faceName = this.getFaceName(cardData.config.CardFace);\r\n        console.log(`点击卡牌: ${suitName}${faceName}`);\r\n        console.log(`移动目标位置: (${targetX}, ${targetY})`);\r\n\r\n        // 使用tween动画移动卡牌（直接使用配置值，不进行额外调整）\r\n        tween(cardNode)\r\n            .to(0.3, { position: new Vec3(targetX, targetY, 0) })\r\n            .start();\r\n\r\n        // 更新卡牌数据的位置\r\n        cardData.updatePosition(targetX, targetY);\r\n\r\n        // 更新层级到最上层\r\n        cardNode.setSiblingIndex(100);\r\n        cardData.zIndex = 100;\r\n    }\r\n\r\n    /**\r\n     * 获取花色名称\r\n     */\r\n    private getSuitName(suit: number): string {\r\n        const suits = ['♠', '♥', '♣', '♦'];\r\n        return suits[suit] || '?';\r\n    }\r\n\r\n    /**\r\n     * 获取牌面名称\r\n     */\r\n    private getFaceName(face: number): string {\r\n        const faces = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];\r\n        return faces[face] || '?';\r\n    }\r\n\r\n    /**\r\n     * 撤销上一步操作\r\n     */\r\n    public onUndoClick(): void {\r\n        const success = DataManager.instance.undo();\r\n        if (success) {\r\n            console.log('撤销成功！');\r\n            // 刷新所有卡牌显示\r\n            this.refreshAllCardsDisplay();\r\n        } else {\r\n            console.log('无法撤销');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 从节点获取卡牌数据\r\n     */\r\n    private getCardDataFromNode(cardNode: Node): CardModel | undefined {\r\n        // 通过节点属性获取卡牌ID\r\n        console.log('=== getCardDataFromNode 开始 ===');\r\n        console.log('节点名称:', cardNode.name);\r\n        console.log('节点完整信息:', cardNode);\r\n\r\n        // 尝试从节点属性中获取cardId\r\n        const cardId = (cardNode as any).cardId;\r\n        console.log('从节点属性提取的cardId:', cardId);\r\n\r\n        if (!cardId) {\r\n            console.log('节点上没有cardId属性');\r\n            return undefined;\r\n        }\r\n\r\n        const cardData = DataManager.instance.gameModel.getCardById(cardId);\r\n        console.log('获取到的cardData:', cardData);\r\n\r\n        return cardData;\r\n    }\r\n\r\n    /**\r\n     * 刷新卡牌显示\r\n     */\r\n    private refreshCardDisplay(cardNode: Node, cardData: CardModel): void {\r\n        this.setupCardDisplay(cardNode, cardData);\r\n    }\r\n\r\n    /**\r\n     * 移除手牌最后一张的视图\r\n     */\r\n    private removeLastHandCardView(): void {\r\n        const lastCard = DataManager.instance.gameModel.getLastHandCard();\r\n        if (lastCard) {\r\n            const lastCardNode = this.handArea.getChildByPath(lastCard.id);\r\n            if (lastCardNode) {\r\n                lastCardNode.removeFromParent();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 刷新手牌显示\r\n     */\r\n    private refreshHandCardsDisplay(): void {\r\n        this.handArea.removeAllChildren();\r\n        const totalHandCards = DataManager.instance.gameModel.handCards.size;\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        DataManager.instance.gameModel.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 刷新所有卡牌显示\r\n     */\r\n    private refreshAllCardsDisplay(): void {\r\n        this.createCardsFromData();\r\n    }\r\n}\r\n"]}