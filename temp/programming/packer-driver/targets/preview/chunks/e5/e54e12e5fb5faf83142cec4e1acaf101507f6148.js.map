{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/controllers/LevelController_new.ts"],"names":["_decorator","Color","Component","instantiate","Node","Prefab","Sprite","SpriteFrame","GameConfig","DataManager","CardUtils","ccclass","property","LevelController","onLoad","initializeConfig","loadLevel","createCardsFromData","instance","initialize","success","console","error","cardPrefab","tableArea","removeAllChildren","handArea","layoutConfig","tableCards","forEach","cardData","createTableCard","totalHandCards","handCards","size","createHandCard","cardNode","addChild","setupCardDisplay","posX","position","x","posY","y","setPosition","setSiblingIndex","zIndex","totalCards","setupHandCardPosition","log","handConf","handLayout","stackX","startX","startY","spacingX","stackSpacingX","separateX","separateCardX","separateY","separateCardY","index","Array","from","values","indexOf","config","isRed","isRedSuit","CardSuit","setSprite","name","spriteFrame","node","getChildByName","sp","getComponent","color","WHITE","getNumberSprite","CardFace","suitSprites","length","currentArea","getCardName","face","isBig","faceIndex","getFaceIndex","arr","bigRedNumbers","bigBlackNumbers","smallRedNumbers","smallBlackNumbers","onTableCardClick","getCardDataFromNode","executeMatch","id","refreshCardDisplay","removeLastHandCardView","onHandCardClick","replaceLastHandCard","refreshHandCardsDisplay","onUndoClick","undo","refreshAllCardsDisplay","cardId","split","getCardById","lastCard","getLastHandCard","lastCardNode","getChildByPath","removeFromParent"],"mappings":"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","sourcesContent":["import { _decorator, Color, Component, instantiate, Node, Prefab, Sprite, SpriteFrame } from 'cc';\r\nimport { GameConfig } from '../configs/GameConfig';\r\nimport { CardConfig } from '../models/CardData';\r\nimport { RuntimeCardData } from '../models/RuntimeCardData';\r\nimport { DataManager } from '../managers/DataManager';\r\nimport { CardUtils } from '../utils/CardUtils';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('LevelController')\r\nexport default class LevelController extends Component {\r\n    // --- 属性定义 ---\r\n    @property(Prefab) cardPrefab: Prefab = null;\r\n    @property(Node) handArea: Node = null;\r\n    @property(Node) tableArea: Node = null;\r\n\r\n    // --- 资源引用 ---\r\n    @property([SpriteFrame]) bigRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) bigBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) suitSprites: SpriteFrame[] = [];\r\n\r\n    async onLoad() {\r\n        // 1. 初始化配置\r\n        await this.initializeConfig();\r\n        // 2. 加载关卡\r\n        await this.loadLevel();\r\n        // 3. 创建卡牌视图\r\n        this.createCardsFromData();\r\n    }\r\n\r\n    private async initializeConfig(): Promise<void> {\r\n        await GameConfig.instance.initialize();\r\n    }\r\n\r\n    private async loadLevel(): Promise<void> {\r\n        const success = await DataManager.instance.loadLevel(1);\r\n        if (!success) {\r\n            console.error('加载关卡失败');\r\n        }\r\n    }\r\n\r\n    private createCardsFromData(): void {\r\n        if (!this.cardPrefab) return;\r\n\r\n        this.tableArea.removeAllChildren();\r\n        this.handArea.removeAllChildren();\r\n\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        // 1. 创建桌面牌\r\n        DataManager.instance.tableCards.forEach((cardData) => {\r\n            this.createTableCard(cardData, layoutConfig);\r\n        });\r\n\r\n        // 2. 创建手牌\r\n        const totalHandCards = DataManager.instance.handCards.size;\r\n        DataManager.instance.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n    }\r\n\r\n    // --- 创建桌面牌 ---\r\n    private createTableCard(cardData: RuntimeCardData, layoutConfig: any): void {\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n\r\n        // 使用RuntimeCardData中的位置\r\n        let posX = cardData.position.x;\r\n        let posY = cardData.position.y;\r\n\r\n        // 简单的向下微调，防止卡牌超出屏幕上边缘\r\n        posX = posX - 540;\r\n        posY = posY - 960 + 300;\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(cardData.zIndex); // 确保渲染顺序\r\n    }\r\n\r\n    // --- 创建手牌 ---\r\n    private createHandCard(cardData: RuntimeCardData, layoutConfig: any, totalCards: number): void {\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.handArea.addChild(cardNode);\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n        this.setupHandCardPosition(cardNode, cardData, layoutConfig, totalCards);\r\n    }\r\n\r\n    // --- 设置手牌位置 ---\r\n    private setupHandCardPosition(\r\n        cardNode: Node,\r\n        cardData: RuntimeCardData,\r\n        layoutConfig: any,\r\n        totalCards: number\r\n    ): void {\r\n        // 安全获取配置\r\n        console.log('布局配置:', layoutConfig);\r\n        const handConf = layoutConfig?.handLayout || {};\r\n\r\n        // 读取配置参数 (带有默认值)\r\n        const stackX = handConf.startX ?? -200;\r\n        const startY = handConf.startY ?? -750;\r\n        const spacingX = handConf.stackSpacingX ?? 100;\r\n\r\n        // 右侧单张的位置\r\n        const separateX = handConf.separateCardX ?? 350;\r\n        const separateY = handConf.separateCardY ?? startY;\r\n\r\n        // 获取当前卡牌的索引\r\n        const index = Array.from(DataManager.instance.handCards.values()).indexOf(cardData);\r\n\r\n        let posX = 0;\r\n        let posY = startY;\r\n        let zIndex = cardData.zIndex;\r\n\r\n        // 判断是否是最后一张\r\n        if (index === totalCards - 1) {\r\n            posX = separateX;\r\n            posY = separateY;\r\n            zIndex = 100;\r\n        } else {\r\n            posX = stackX + (index * spacingX);\r\n            posY = startY;\r\n        }\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(zIndex);\r\n\r\n        console.log(`手牌 ${index} 位置: (${posX}, ${posY})`);\r\n    }\r\n\r\n    // --- 通用显示设置 ---\r\n    private setupCardDisplay(cardNode: Node, cardData: RuntimeCardData): void {\r\n        const config = cardData.config;\r\n        const isRed = CardUtils.isRedSuit(config.CardSuit);\r\n\r\n        // 辅助函数：安全设置图片\r\n        const setSprite = (name: string, spriteFrame: SpriteFrame) => {\r\n            const node = cardNode.getChildByName(name);\r\n            if (node) {\r\n                const sp = node.getComponent(Sprite);\r\n                if (sp) {\r\n                    sp.spriteFrame = spriteFrame;\r\n                    sp.color = Color.WHITE;\r\n                }\r\n            }\r\n        };\r\n\r\n        setSprite('bigNum', this.getNumberSprite(config.CardFace, true, isRed));\r\n        setSprite('smallNum', this.getNumberSprite(config.CardFace, false, isRed));\r\n\r\n        if (config.CardSuit >= 0 && config.CardSuit < this.suitSprites.length) {\r\n            setSprite('suit', this.suitSprites[config.CardSuit]);\r\n        }\r\n\r\n        cardNode.name = `${cardData.currentArea}_${CardUtils.getCardName(config.CardSuit, config.CardFace)}`;\r\n    }\r\n\r\n    private getNumberSprite(face: number, isBig: boolean, isRed: boolean): SpriteFrame | null {\r\n        const faceIndex = CardUtils.getFaceIndex(face);\r\n        if (faceIndex < 0 || faceIndex > 12) return null;\r\n        const arr = isBig\r\n            ? (isRed ? this.bigRedNumbers : this.bigBlackNumbers)\r\n            : (isRed ? this.smallRedNumbers : this.smallBlackNumbers);\r\n        return arr[faceIndex] || null;\r\n    }\r\n\r\n    // --- 游戏操作 ---\r\n\r\n    /**\r\n     * 处理桌面卡牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     */\r\n    public onTableCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'table') return;\r\n\r\n        const success = DataManager.instance.executeMatch(cardData.id);\r\n        if (success) {\r\n            console.log('匹配成功！');\r\n            // 刷新显示\r\n            this.refreshCardDisplay(cardNode, cardData);\r\n            // 移除手牌最后一张的视图\r\n            this.removeLastHandCardView();\r\n        } else {\r\n            console.log('无法匹配');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理手牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     */\r\n    public onHandCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'hand') return;\r\n\r\n        const success = DataManager.instance.replaceLastHandCard(cardData.id);\r\n        if (success) {\r\n            console.log('替换成功！');\r\n            // 刷新手牌显示\r\n            this.refreshHandCardsDisplay();\r\n        } else {\r\n            console.log('无法替换');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 撤销上一步操作\r\n     */\r\n    public onUndoClick(): void {\r\n        const success = DataManager.instance.undo();\r\n        if (success) {\r\n            console.log('撤销成功！');\r\n            // 刷新所有卡牌显示\r\n            this.refreshAllCardsDisplay();\r\n        } else {\r\n            console.log('无法撤销');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 从节点获取卡牌数据\r\n     */\r\n    private getCardDataFromNode(cardNode: Node): RuntimeCardData | undefined {\r\n        // 通过节点名称或其他方式获取卡牌ID\r\n        // 这里需要根据实际实现调整\r\n        const cardId = cardNode.name.split('_')[1];\r\n        return DataManager.instance.getCardById(cardId);\r\n    }\r\n\r\n    /**\r\n     * 刷新卡牌显示\r\n     */\r\n    private refreshCardDisplay(cardNode: Node, cardData: RuntimeCardData): void {\r\n        this.setupCardDisplay(cardNode, cardData);\r\n    }\r\n\r\n    /**\r\n     * 移除手牌最后一张的视图\r\n     */\r\n    private removeLastHandCardView(): void {\r\n        const lastCard = DataManager.instance.getLastHandCard();\r\n        if (lastCard) {\r\n            const lastCardNode = this.handArea.getChildByPath(lastCard.id);\r\n            if (lastCardNode) {\r\n                lastCardNode.removeFromParent();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 刷新手牌显示\r\n     */\r\n    private refreshHandCardsDisplay(): void {\r\n        this.handArea.removeAllChildren();\r\n        const totalHandCards = DataManager.instance.handCards.size;\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        DataManager.instance.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 刷新所有卡牌显示\r\n     */\r\n    private refreshAllCardsDisplay(): void {\r\n        this.createCardsFromData();\r\n    }\r\n}\r\n"]}