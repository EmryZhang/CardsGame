{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/controllers/LevelController.ts"],"names":["_decorator","Color","Component","instantiate","JsonAsset","Node","Prefab","resources","Sprite","SpriteFrame","GameConfig","ccclass","property","LevelController","suitSymbols","faceTexts","levelConfig","onLoad","initializeConfig","loadLevelFromFile","instance","initialize","load","err","asset","console","error","json","createCardsFromConfig","cardPrefab","tableArea","removeAllChildren","handArea","layoutConfig","Playfield","forEach","cardConfig","index","createTableCard","totalHandCards","Stack","length","createHandCard","config","cardNode","addChild","setupCardDisplay","posX","Position","x","posY","y","setPosition","setSiblingIndex","totalCards","setupHandCardPosition","log","handConf","handLayout","stackX","stackStartX","startY","stackStartY","spacingX","horizontalSpacing","stackSpacingX","separateX","separateCardX","separateY","separateCardY","zIndex","area","isRed","isRedSuit","CardSuit","setSprite","name","spriteFrame","node","getChildByName","sp","getComponent","color","WHITE","getNumberSprite","CardFace","suitSprites","getCardName","suit","face","isBig","arr","bigRedNumbers","bigBlackNumbers","smallRedNumbers","smallBlackNumbers"],"mappings":"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","sourcesContent":["import { _decorator, Color, Component, instantiate, JsonAsset, Node, Prefab, resources, Sprite, SpriteFrame } from 'cc';\r\nimport { GameConfig } from '../configs/GameConfig';\r\nimport { CardConfig, LevelConfig } from '../models/CardData';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('LevelController')\r\nexport default class LevelController extends Component {\r\n    // --- 属性定义 ---\r\n    @property(Prefab) cardPrefab: Prefab = null;\r\n    @property(Node) handArea: Node = null;\r\n    @property(Node) tableArea: Node = null;\r\n    \r\n    // --- 资源引用 ---\r\n    @property([SpriteFrame]) bigRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) bigBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) suitSprites: SpriteFrame[] = [];\r\n    \r\n    private suitSymbols: string[] = ['♣', '♦', '♥', '♠'];\r\n    private faceTexts: string[] = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];\r\n    \r\n    private levelConfig: LevelConfig = null;\r\n    \r\n    async onLoad() {\r\n        // 1. 初始化配置\r\n        await this.initializeConfig();\r\n        // 2. 加载关卡\r\n        this.loadLevelFromFile();\r\n    }\r\n\r\n    private async initializeConfig(): Promise<void> {\r\n        await GameConfig.instance.initialize();\r\n    }\r\n    \r\n    private loadLevelFromFile(): void {\r\n        resources.load('levels/level_1', JsonAsset, (err, asset) => {\r\n            if (err) return console.error(err);\r\n            this.levelConfig = asset.json as LevelConfig;\r\n            this.createCardsFromConfig();\r\n        });\r\n    }\r\n    \r\n    private createCardsFromConfig(): void {\r\n        if (!this.levelConfig || !this.cardPrefab) return;\r\n        \r\n        this.tableArea.removeAllChildren();\r\n        this.handArea.removeAllChildren();\r\n        \r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n        \r\n        // 1. 创建桌面牌\r\n        this.levelConfig.Playfield?.forEach((cardConfig, index) => {\r\n            this.createTableCard(cardConfig, index, layoutConfig);\r\n        });\r\n        \r\n        // 2. 创建手牌\r\n        const totalHandCards = this.levelConfig.Stack?.length || 0;\r\n        this.levelConfig.Stack?.forEach((cardConfig, index) => {\r\n            this.createHandCard(cardConfig, index, layoutConfig, totalHandCards);\r\n        });\r\n    }\r\n    \r\n    // --- 创建桌面牌 ---\r\n    private createTableCard(config: CardConfig, index: number, layoutConfig: any): void {\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n        \r\n        this.setupCardDisplay(cardNode, config, 'table', index);\r\n        \r\n        // 读取配置位置\r\n        // 注意：这里保留了简单的坐标转换，如果你的配置已经是Cocos坐标，可以去掉偏移计算\r\n        let posX = config.Position.x;\r\n        let posY = config.Position.y;\r\n        \r\n        // 简单的向下微调，防止卡牌超出屏幕上边缘\r\n        posX = posX - 540;  \r\n        posY = posY - 960 + 300; \r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(index); // 确保渲染顺序\r\n    }\r\n    \r\n    // --- 创建手牌 (核心修改逻辑) ---\r\n    private createHandCard(config: CardConfig, index: number, layoutConfig: any, totalCards: number): void {\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.handArea.addChild(cardNode);\r\n        \r\n        this.setupCardDisplay(cardNode, config, 'hand', index);\r\n        this.setupHandCardPosition(cardNode, index, layoutConfig, totalCards);\r\n    }\r\n\r\n    // --- 设置手牌位置 (已移除硬编码，改为通用逻辑) ---\r\n    private setupHandCardPosition(\r\n        cardNode: Node, \r\n        index: number, \r\n        layoutConfig: any, \r\n        totalCards: number\r\n    ): void {\r\n        // 安全获取配置，如果 layoutConfig 为空，使用后面的默认值 (??) 防止不显示\r\n        console.log('布局配置:', layoutConfig);\r\n        // 这里为了兼容你可能还没改好的 JSON 字段，做了一些兼容处理\r\n        const handConf = layoutConfig?.handLayout || {};\r\n        \r\n        // 读取配置参数 (带有默认值，保证绝对能显示出来)\r\n        const stackX = handConf.stackStartX ?? handConf.stackStartX ?? -350;\r\n        const startY = handConf.stackStartY ?? 0;\r\n        const spacingX = handConf.horizontalSpacing ?? handConf.stackSpacingX ?? 100;\r\n        \r\n        // 右侧单张的位置\r\n        const separateX = handConf.separateCardX ?? handConf.separateCardX ?? 200; \r\n        const separateY = handConf.separateCardY ?? handConf.separateCardY ?? startY;\r\n\r\n        let posX = 0;\r\n        let posY = startY;\r\n        let zIndex = index;\r\n\r\n        // --- 核心逻辑：判断是否是最后一张 ---\r\n        if (index === totalCards - 1) {\r\n            // 是最后一张 -> 放在右边固定位置\r\n            posX = separateX;\r\n            posY = separateY;\r\n            zIndex = 100; // 放在最上层\r\n        } else {\r\n            // 是前面的牌 -> 左边堆叠\r\n            // 公式：起始X + (当前索引 * 间距)\r\n            posX = stackX + (index * spacingX);\r\n            posY = startY;\r\n            zIndex = index; // 正常层级\r\n        }\r\n        \r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(zIndex);\r\n        \r\n        console.log(`手牌 ${index} 位置: (${posX}, ${posY})`);\r\n    }\r\n\r\n    // --- 通用显示设置 ---\r\n    private setupCardDisplay(cardNode: Node, config: CardConfig, area: string, index: number): void {\r\n        const isRed = this.isRedSuit(config.CardSuit);\r\n        \r\n        // 辅助函数：安全设置图片\r\n        const setSprite = (name: string, spriteFrame: SpriteFrame) => {\r\n            const node = cardNode.getChildByName(name);\r\n            if (node) {\r\n                const sp = node.getComponent(Sprite);\r\n                if (sp) {\r\n                    sp.spriteFrame = spriteFrame;\r\n                    sp.color = Color.WHITE;\r\n                }\r\n            }\r\n        };\r\n\r\n        setSprite('bigNum', this.getNumberSprite(config.CardFace, true, isRed));\r\n        setSprite('smallNum', this.getNumberSprite(config.CardFace, false, isRed));\r\n        \r\n        if (config.CardSuit >= 0 && config.CardSuit < this.suitSprites.length) {\r\n            setSprite('suit', this.suitSprites[config.CardSuit]);\r\n        }\r\n\r\n        cardNode.name = `${area}_${index}_${this.getCardName(config)}`;\r\n    }\r\n    \r\n    private isRedSuit(suit: number): boolean {\r\n        return suit === 1 || suit === 2;\r\n    }\r\n    \r\n    private getNumberSprite(face: number, isBig: boolean, isRed: boolean): SpriteFrame | null {\r\n        if (face < 0 || face > 12) return null;\r\n        const arr = isBig \r\n            ? (isRed ? this.bigRedNumbers : this.bigBlackNumbers)\r\n            : (isRed ? this.smallRedNumbers : this.smallBlackNumbers);\r\n        return arr[face] || null;\r\n    }\r\n    \r\n    private getCardName(config: CardConfig): string {\r\n        return `${this.suitSymbols[config.CardSuit] || '?'}${this.faceTexts[config.CardFace] || '?'}`;\r\n    }\r\n}\r\n"]}