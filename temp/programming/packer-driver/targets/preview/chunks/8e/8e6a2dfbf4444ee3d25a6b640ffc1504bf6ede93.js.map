{"version":3,"sources":["file:///D:/Work/job/CardsGame/assets/Classes/controllers/LevelController.ts"],"names":["_decorator","Color","Component","instantiate","Node","Prefab","Sprite","SpriteFrame","tween","Vec3","GameConfig","DataManager","CardService","CardUtils","CardView","ccclass","property","LevelController","historyStack","onLoad","initializeConfig","loadLevel","createCardsFromData","setupUndoButton","instance","initialize","success","console","error","gameModel","updateTopAndReserveCards","undoButton","warn","on","EventType","TOUCH_END","undoLastMove","saveCardMoveRecord","cardData","targetPosition","children","tableArea","cardNode","i","length","child","cardId","id","currentPosition","getPosition","currentTopCard","topCard","reserveCards","previousReserveCardIds","map","card","record","fromPosition","x","y","toPosition","fromArea","currentArea","toArea","zIndex","previousTopCardId","push","log","lastRecord","pop","targetX","targetY","to","position","call","previousTopCard","getCardById","suitName","getSuitName","config","CardSuit","faceName","getFaceName","CardFace","restoredReserveCards","forEach","start","getCardDataFromNode","updatePosition","setSiblingIndex","cardPrefab","removeAllChildren","layoutConfig","tableCards","createTableCard","totalHandCards","handCards","size","createHandCard","Array","from","values","addChild","setupCardDisplay","setupTableCardPosition","cardView","getComponent","setClickCallback","view","onTableCardClick","relativePos","convertAbsoluteToRelativeForTable","posX","posY","setPosition","totalCards","setupHandCardPosition","getCardData","onHandCardClick","handConf","handLayout","stackX","stackStartX","startY","stackStartY","spacingX","stackSpacingX","separateX","separateCardX","separateY","separateCardY","index","indexOf","isRed","isRedSuit","init","setSprite","name","spriteFrame","node","getChildByName","sp","color","WHITE","getNumberSprite","suitSprites","getCardName","face","isBig","arr","bigRedNumbers","bigBlackNumbers","smallRedNumbers","smallBlackNumbers","handleCardClick","topSuitName","topFaceName","cardIndex","currentReserveCards","cardIndex2","splice","canMove","canMoveToCard","calculateTargetPosition","areaName","newTopCard","updateTopCard","lastHandCard","suit","suits","faces","onUndoClick","undo","refreshAllCardsDisplay","undefined","refreshCardDisplay","removeLastHandCardView","lastCard","getLastHandCard","removeFromParent","refreshHandCardsDisplay","get"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,I,OAAAA,I;;AACrFC,MAAAA,U,iBAAAA,U;;AACAC,MAAAA,W,iBAAAA,W;;AAEAC,MAAAA,W,iBAAAA,W;;AACAC,MAAAA,S,iBAAAA,S;;AACFC,MAAAA,Q;;;;;;;;;OAED;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBhB,U,GAE9B;;yBAeqBiB,e,WADpBF,OAAO,CAAC,iBAAD,C,UAGHC,QAAQ,CAACX,MAAD,C,UACRW,QAAQ,CAACZ,IAAD,C,UACRY,QAAQ,CAACZ,IAAD,C,UAGRY,QAAQ,CAAC,CAACT,WAAD,CAAD,C,UAGRS,QAAQ,CAAC,CAACT,WAAD,CAAD,C,UACRS,QAAQ,CAAC,CAACT,WAAD,CAAD,C,UACRS,QAAQ,CAAC,CAACT,WAAD,CAAD,C,UACRS,QAAQ,CAAC,CAACT,WAAD,CAAD,C,2BAdb,MACqBU,eADrB,SAC6Cf,SAD7C,CACuD;AAAA;AAAA;;AACnD;AADmD;;AAAA;;AAAA;;AAMnD;AANmD;;AASnD;AATmD;;AAAA;;AAAA;;AAAA;;AAenD;AAfmD,eAgB3CgB,YAhB2C,GAgBV,EAhBU;AAAA;;AAkB7CC,QAAAA,MAAM,GAAG;AAAA;;AAAA;AACX;AACA,kBAAM,KAAI,CAACC,gBAAL,EAAN,CAFW,CAGX;;AACA,kBAAM,KAAI,CAACC,SAAL,EAAN,CAJW,CAKX;;AACA,YAAA,KAAI,CAACC,mBAAL,GANW,CAOX;;;AACA,YAAA,KAAI,CAACC,eAAL;AARW;AASd;;AAEaH,QAAAA,gBAAgB,GAAkB;AAAA;AAC5C,kBAAM;AAAA;AAAA,0CAAWI,QAAX,CAAoBC,UAApB,EAAN;AAD4C;AAE/C;;AAEaJ,QAAAA,SAAS,GAAkB;AAAA;AACrC,gBAAMK,OAAO,SAAS;AAAA;AAAA,4CAAYF,QAAZ,CAAqBH,SAArB,CAA+B,CAA/B,CAAtB;;AACA,gBAAI,CAACK,OAAL,EAAc;AACVC,cAAAA,OAAO,CAACC,KAAR,CAAc,QAAd;AACH,aAFD,MAEO;AACH;AACA;AAAA;AAAA,8CAAYJ,QAAZ,CAAqBK,SAArB,CAA+BC,wBAA/B;AACH;AAPoC;AAQxC;AAED;AACJ;AACA;;;AACYP,QAAAA,eAAe,GAAS;AAC5B,cAAI,CAAC,KAAKQ,UAAV,EAAsB;AAClBJ,YAAAA,OAAO,CAACK,IAAR,CAAa,SAAb;AACA;AACH;;AAED,eAAKD,UAAL,CAAgBE,EAAhB,CAAmB7B,IAAI,CAAC8B,SAAL,CAAeC,SAAlC,EAA6C,MAAM;AAC/C,iBAAKC,YAAL;AACH,WAFD,EAEG,IAFH;AAGH;AAED;AACJ;AACA;AACA;AACA;;;AACYC,QAAAA,kBAAkB,CAACC,QAAD,EAAsBC,cAAtB,EAAsE;AAC5F;AACA,cAAMC,QAAQ,GAAG,KAAKC,SAAL,CAAeD,QAAhC;AACA,cAAIE,QAAqB,GAAG,IAA5B;;AACA,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,QAAQ,CAACI,MAA7B,EAAqCD,CAAC,EAAtC,EAA0C;AACtC,gBAAME,KAAK,GAAGL,QAAQ,CAACG,CAAD,CAAtB;AACA,gBAAMG,MAAM,GAAID,KAAD,CAAeC,MAA9B;;AACA,gBAAIA,MAAM,KAAKR,QAAQ,CAACS,EAAxB,EAA4B;AACxBL,cAAAA,QAAQ,GAAGG,KAAX;AACA;AACH;AACJ;;AAED,cAAI,CAACH,QAAL,EAAe;AACXf,YAAAA,OAAO,CAACC,KAAR,kDAA0BU,QAAQ,CAACS,EAAnC;AACA;AACH,WAhB2F,CAkB5F;;;AACA,cAAMC,eAAe,GAAGN,QAAQ,CAACO,WAAT,EAAxB,CAnB4F,CAqB5F;;AACA,cAAMC,cAAc,GAAG;AAAA;AAAA,0CAAY1B,QAAZ,CAAqBK,SAArB,CAA+BsB,OAAtD;AACA,cAAMC,YAAY,GAAG;AAAA;AAAA,0CAAY5B,QAAZ,CAAqBK,SAArB,CAA+BuB,YAApD,CAvB4F,CAyB5F;;AACA,cAAMC,sBAAsB,GAAGD,YAAY,CAACE,GAAb,CAAiBC,IAAI,IAAIA,IAAI,CAACR,EAA9B,CAA/B;AAEA,cAAMS,MAAsB,GAAG;AAC3BV,YAAAA,MAAM,EAAER,QAAQ,CAACS,EADU;AAE3BU,YAAAA,YAAY,EAAE;AAAEC,cAAAA,CAAC,EAAEV,eAAe,CAACU,CAArB;AAAwBC,cAAAA,CAAC,EAAEX,eAAe,CAACW;AAA3C,aAFa;AAG3BC,YAAAA,UAAU,EAAE;AAAEF,cAAAA,CAAC,EAAEnB,cAAc,CAACmB,CAApB;AAAuBC,cAAAA,CAAC,EAAEpB,cAAc,CAACoB;AAAzC,aAHe;AAI3BE,YAAAA,QAAQ,EAAEvB,QAAQ,CAACwB,WAJQ;AAK3BC,YAAAA,MAAM,EAAEzB,QAAQ,CAACwB,WALU;AAKG;AAC9BE,YAAAA,MAAM,EAAE1B,QAAQ,CAAC0B,MANU;AAO3BC,YAAAA,iBAAiB,EAAEf,cAAc,GAAGA,cAAc,CAACH,EAAlB,GAAuB,IAP7B;AAQ3BM,YAAAA,sBAAsB,EAAEA;AARG,WAA/B;AAWA,eAAKnC,YAAL,CAAkBgD,IAAlB,CAAuBV,MAAvB;AACH;AAED;AACJ;AACA;;;AACYpB,QAAAA,YAAY,GAAS;AACzB,cAAI,KAAKlB,YAAL,CAAkB0B,MAAlB,KAA6B,CAAjC,EAAoC;AAChCjB,YAAAA,OAAO,CAACwC,GAAR,CAAY,UAAZ;AACA;AACH;;AAED,cAAMC,UAAU,GAAG,KAAKlD,YAAL,CAAkBmD,GAAlB,EAAnB;AACA,cAAI,CAACD,UAAL,EAAiB;AAEjBzC,UAAAA,OAAO,CAACwC,GAAR,CAAY,SAAZ,EAAuBC,UAAvB,EATyB,CAWzB;;AACA,cAAM5B,QAAQ,GAAG,KAAKC,SAAL,CAAeD,QAAhC;;AACA,eAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,QAAQ,CAACI,MAA7B,EAAqCD,CAAC,EAAtC,EAA0C;AACtC,gBAAME,KAAK,GAAGL,QAAQ,CAACG,CAAD,CAAtB;AACA,gBAAMG,MAAM,GAAID,KAAD,CAAeC,MAA9B;;AAEA,gBAAIA,MAAM,KAAKsB,UAAU,CAACtB,MAA1B,EAAkC;AAC9B;AACA;AACA,kBAAMwB,OAAO,GAAGF,UAAU,CAACX,YAAX,CAAwBC,CAAxC;AACA,kBAAMa,OAAO,GAAGH,UAAU,CAACX,YAAX,CAAwBE,CAAxC,CAJ8B,CAM9B;;AACAnD,cAAAA,KAAK,CAACqC,KAAD,CAAL,CACK2B,EADL,CACQ,GADR,EACa;AAAEC,gBAAAA,QAAQ,EAAE,IAAIhE,IAAJ,CAAS6D,OAAT,EAAkBC,OAAlB,EAA2B,CAA3B;AAAZ,eADb,EAEKG,IAFL,CAEU,MAAM;AACR;AACA,oBAAIN,UAAU,CAACH,iBAAf,EAAkC;AAC9B,sBAAMU,eAAe,GAAG;AAAA;AAAA,kDAAYnD,QAAZ,CAAqBK,SAArB,CAA+B+C,WAA/B,CAA2CR,UAAU,CAACH,iBAAtD,CAAxB;;AACA,sBAAIU,eAAJ,EAAqB;AACjB;AAAA;AAAA,oDAAYnD,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,GAAyCwB,eAAzC;AACA,wBAAME,QAAQ,GAAG,KAAKC,WAAL,CAAiBH,eAAe,CAACI,MAAhB,CAAuBC,QAAxC,CAAjB;AACA,wBAAMC,QAAQ,GAAG,KAAKC,WAAL,CAAiBP,eAAe,CAACI,MAAhB,CAAuBI,QAAxC,CAAjB;AACAxD,oBAAAA,OAAO,CAACwC,GAAR,gCAAqBU,QAArB,GAAgCI,QAAhC;AACH;AACJ,iBARD,MAQO;AACH;AACA;AAAA;AAAA,kDAAYzD,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,GAAyC,IAAzC;AACAxB,kBAAAA,OAAO,CAACwC,GAAR,CAAY,SAAZ;AACH,iBAdO,CAgBR;;;AACA,oBAAIC,UAAU,CAACf,sBAAX,IAAqCe,UAAU,CAACf,sBAAX,CAAkCT,MAAlC,GAA2C,CAApF,EAAuF;AACnF,sBAAMwC,oBAAiC,GAAG,EAA1C;AACAhB,kBAAAA,UAAU,CAACf,sBAAX,CAAkCgC,OAAlC,CAA0CvC,MAAM,IAAI;AAChD,wBAAMS,IAAI,GAAG;AAAA;AAAA,oDAAY/B,QAAZ,CAAqBK,SAArB,CAA+B+C,WAA/B,CAA2C9B,MAA3C,CAAb;;AACA,wBAAIS,IAAJ,EAAU;AACN6B,sBAAAA,oBAAoB,CAAClB,IAArB,CAA0BX,IAA1B;AACH;AACJ,mBALD;AAMA;AAAA;AAAA,kDAAY/B,QAAZ,CAAqBK,SAArB,CAA+BuB,YAA/B,GAA8CgC,oBAA9C;AACAzD,kBAAAA,OAAO,CAACwC,GAAR,kDAAwBiB,oBAAoB,CAACxC,MAA7C;AACH,iBAVD,MAUO;AACH;AAAA;AAAA,kDAAYpB,QAAZ,CAAqBK,SAArB,CAA+BuB,YAA/B,GAA8C,EAA9C;AACAzB,kBAAAA,OAAO,CAACwC,GAAR,CAAY,YAAZ;AACH;AACJ,eAjCL,EAkCKmB,KAlCL,GAP8B,CA2C9B;;AACA,kBAAMhD,QAAQ,GAAG,KAAKiD,mBAAL,CAAyB1C,KAAzB,CAAjB;;AACA,kBAAIP,QAAJ,EAAc;AACVA,gBAAAA,QAAQ,CAACkD,cAAT,CAAwBlB,OAAxB,EAAiCC,OAAjC;AACAjC,gBAAAA,QAAQ,CAAC0B,MAAT,GAAkBI,UAAU,CAACJ,MAA7B;AACH,eAhD6B,CAkD9B;;;AACAnB,cAAAA,KAAK,CAAC4C,eAAN,CAAsBrB,UAAU,CAACJ,MAAjC;AAEA;AACH;AACJ;AACJ;;AAEO1C,QAAAA,mBAAmB,GAAS;AAChC,cAAI,CAAC,KAAKoE,UAAV,EAAsB;AAEtB,eAAKjD,SAAL,CAAekD,iBAAf;AAEA,cAAMC,YAAY,GAAG;AAAA;AAAA,wCAAWpE,QAAX,CAAoBoE,YAAzC,CALgC,CAOhC;;AACA;AAAA;AAAA,0CAAYpE,QAAZ,CAAqBK,SAArB,CAA+BgE,UAA/B,CAA0CR,OAA1C,CAAmD/C,QAAD,IAAc;AAC5D,iBAAKwD,eAAL,CAAqBxD,QAArB,EAA+BsD,YAA/B;AACH,WAFD,EARgC,CAYhC;;AACA,cAAMG,cAAc,GAAG;AAAA;AAAA,0CAAYvE,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCC,IAAhE;AACA;AAAA;AAAA,0CAAYzE,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCX,OAAzC,CAAkD/C,QAAD,IAAc;AAC3D,iBAAK4D,cAAL,CAAoB5D,QAApB,EAA8BsD,YAA9B,EAA4CG,cAA5C;AACH,WAFD,EAdgC,CAkBhC;;AACA,cAAMC,SAAS,GAAGG,KAAK,CAACC,IAAN,CAAW;AAAA;AAAA,0CAAY5E,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCK,MAAzC,EAAX,CAAlB;;AACA,cAAIL,SAAS,CAACpD,MAAV,GAAmB,CAAvB,EAA0B;AACtB;AAAA;AAAA,4CAAYpB,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,GAAyC6C,SAAS,CAACA,SAAS,CAACpD,MAAV,GAAmB,CAApB,CAAlD;AACAjB,YAAAA,OAAO,CAACwC,GAAR,gCAAqB,KAAKW,WAAL,CAAiB;AAAA;AAAA,4CAAYtD,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,CAAuC4B,MAAvC,CAA8CC,QAA/D,CAArB,GAAgG,KAAKE,WAAL,CAAiB;AAAA;AAAA,4CAAY1D,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,CAAuC4B,MAAvC,CAA8CI,QAA/D,CAAhG;AACH;AACJ,SA9MkD,CAgNnD;;;AACQW,QAAAA,eAAe,CAACxD,QAAD,EAAsBsD,YAAtB,EAA+C;AAClEjE,UAAAA,OAAO,CAACwC,GAAR,CAAY,QAAZ,EAAsB7B,QAAtB;AACA,cAAMI,QAAQ,GAAGvC,WAAW,CAAC,KAAKuF,UAAN,CAA5B;AACA,eAAKjD,SAAL,CAAe6D,QAAf,CAAwB5D,QAAxB,EAHkE,CAKlE;;AACCA,UAAAA,QAAD,CAAkBI,MAAlB,GAA2BR,QAAQ,CAACS,EAApC;AACApB,UAAAA,OAAO,CAACwC,GAAR,CAAY,kBAAZ,EAAgC7B,QAAQ,CAACS,EAAzC;AAEA,eAAKwD,gBAAL,CAAsB7D,QAAtB,EAAgCJ,QAAhC;AACA,eAAKkE,sBAAL,CAA4B9D,QAA5B,EAAsCJ,QAAtC,EAAgDsD,YAAhD,EAVkE,CAYlE;;AACA,cAAMa,QAAQ,GAAG/D,QAAQ,CAACgE,YAAT;AAAA;AAAA,mCAAjB;;AACA,cAAID,QAAJ,EAAc;AACVA,YAAAA,QAAQ,CAACE,gBAAT,CAA2BC,IAAD,IAAoB;AAC1C,mBAAKC,gBAAL,CAAsBnE,QAAtB;AACH,aAFD;AAGAf,YAAAA,OAAO,CAACwC,GAAR,CAAY,aAAZ;AACH,WALD,MAKO;AACHxC,YAAAA,OAAO,CAACC,KAAR,CAAc,gBAAd;AACH;AACJ,SAvOkD,CAyOnD;;;AACQ4E,QAAAA,sBAAsB,CAC1B9D,QAD0B,EAE1BJ,QAF0B,EAG1BsD,YAH0B,EAItB;AACJ;AACA,cAAMkB,WAAW,GAAG;AAAA;AAAA,sCAAUC,iCAAV,CAChBzE,QAAQ,CAACmC,QAAT,CAAkBf,CADF,EAEhBpB,QAAQ,CAACmC,QAAT,CAAkBd,CAFF,CAApB;AAKA,cAAMqD,IAAI,GAAGF,WAAW,CAACpD,CAAzB;AACA,cAAMuD,IAAI,GAAGH,WAAW,CAACnD,CAAzB;AACA,cAAMK,MAAM,GAAG1B,QAAQ,CAAC0B,MAAxB;AAEAtB,UAAAA,QAAQ,CAACwE,WAAT,CAAqBF,IAArB,EAA2BC,IAA3B,EAAiC,CAAjC;AACAvE,UAAAA,QAAQ,CAAC+C,eAAT,CAAyBzB,MAAzB;AAEArC,UAAAA,OAAO,CAACwC,GAAR,uCAAuB6C,IAAvB,UAAgCC,IAAhC;AACH,SA7PkD,CA+PnD;;;AACQf,QAAAA,cAAc,CAAC5D,QAAD,EAAsBsD,YAAtB,EAAyCuB,UAAzC,EAAmE;AACrFxF,UAAAA,OAAO,CAACwC,GAAR,CAAY,OAAZ,EAAqB7B,QAArB;AACA,cAAMI,QAAQ,GAAGvC,WAAW,CAAC,KAAKuF,UAAN,CAA5B;AACA,eAAKjD,SAAL,CAAe6D,QAAf,CAAwB5D,QAAxB,EAHqF,CAKrF;;AACCA,UAAAA,QAAD,CAAkBI,MAAlB,GAA2BR,QAAQ,CAACS,EAApC;AACApB,UAAAA,OAAO,CAACwC,GAAR,CAAY,kBAAZ,EAAgC7B,QAAQ,CAACS,EAAzC;AAEA,eAAKwD,gBAAL,CAAsB7D,QAAtB,EAAgCJ,QAAhC;AACA,eAAK8E,qBAAL,CAA2B1E,QAA3B,EAAqCJ,QAArC,EAA+CsD,YAA/C,EAA6DuB,UAA7D,EAVqF,CAYrF;;AACA,cAAMV,QAAQ,GAAG/D,QAAQ,CAACgE,YAAT;AAAA;AAAA,mCAAjB;;AACA,cAAID,QAAJ,EAAc;AACVA,YAAAA,QAAQ,CAACE,gBAAT,CAA2BC,IAAD,IAAoB;AAC1CjF,cAAAA,OAAO,CAACwC,GAAR,CAAY,QAAZ,EAAsByC,IAAI,CAACS,WAAL,EAAtB;AACA,mBAAKC,eAAL,CAAqB5E,QAArB;AACH,aAHD;AAIAf,YAAAA,OAAO,CAACwC,GAAR,CAAY,WAAZ;AACH,WAND,MAMO;AACHxC,YAAAA,OAAO,CAACC,KAAR,CAAc,gBAAd;AACH;AACJ,SAvRkD,CAyRnD;;;AACQwF,QAAAA,qBAAqB,CACzB1E,QADyB,EAEzBJ,QAFyB,EAGzBsD,YAHyB,EAIzBuB,UAJyB,EAKrB;AAAA;;AACJ,cAAMI,QAAQ,GAAG,CAAA3B,YAAY,QAAZ,YAAAA,YAAY,CAAE4B,UAAd,KAA4B,EAA7C,CADI,CAGJ;;AACA,cAAMC,MAAM,4BAAGF,QAAQ,CAACG,WAAZ,oCAA2B,CAAC,GAAxC;AACA,cAAMC,MAAM,4BAAGJ,QAAQ,CAACK,WAAZ,oCAA2B,CAAvC;AACA,cAAMC,QAAQ,4BAAGN,QAAQ,CAACO,aAAZ,oCAA6B,GAA3C,CANI,CAQJ;;AACA,cAAMC,SAAS,4BAAGR,QAAQ,CAACS,aAAZ,oCAA6B,GAA5C;AACA,cAAMC,SAAS,6BAAGV,QAAQ,CAACW,aAAZ,qCAA6BP,MAA5C,CAVI,CAYJ;;AACA,cAAMQ,KAAK,GAAGhC,KAAK,CAACC,IAAN,CAAW;AAAA;AAAA,0CAAY5E,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCK,MAAzC,EAAX,EAA8D+B,OAA9D,CAAsE9F,QAAtE,CAAd;AAEA,cAAI0E,IAAI,GAAG,CAAX;AACA,cAAIC,IAAI,GAAGU,MAAX;AACA,cAAI3D,MAAM,GAAGmE,KAAb,CAjBI,CAmBJ;;AACA,cAAIA,KAAK,KAAKhB,UAAU,GAAG,CAA3B,EAA8B;AAC1B;AACAH,YAAAA,IAAI,GAAGe,SAAP;AACAd,YAAAA,IAAI,GAAGgB,SAAP;AACAjE,YAAAA,MAAM,GAAG,GAAT,CAJ0B,CAIZ;AACjB,WALD,MAKO;AACH;AACA;AACAgD,YAAAA,IAAI,GAAGS,MAAM,GAAIU,KAAK,GAAGN,QAAzB;AACAZ,YAAAA,IAAI,GAAGU,MAAP;AACA3D,YAAAA,MAAM,GAAGmE,KAAT,CALG,CAKa;AACnB;;AAEDzF,UAAAA,QAAQ,CAACwE,WAAT,CAAqBF,IAArB,EAA2BC,IAA3B,EAAiC,CAAjC;AACAvE,UAAAA,QAAQ,CAAC+C,eAAT,CAAyBzB,MAAzB,EAlCI,CAoCJ;;AACA1B,UAAAA,QAAQ,CAACkD,cAAT,CAAwBwB,IAAxB,EAA8BC,IAA9B;AACA3E,UAAAA,QAAQ,CAAC0B,MAAT,GAAkBA,MAAlB;AAEArC,UAAAA,OAAO,CAACwC,GAAR,mBAAkBgE,KAAlB,wBAAgCnB,IAAhC,UAAyCC,IAAzC;AACH,SAxUkD,CA0UnD;;;AACQV,QAAAA,gBAAgB,CAAC7D,QAAD,EAAiBJ,QAAjB,EAA4C;AAChE,cAAMyC,MAAM,GAAGzC,QAAQ,CAACyC,MAAxB;AACA,cAAMsD,KAAK,GAAG;AAAA;AAAA,sCAAUC,SAAV,CAAoBvD,MAAM,CAACC,QAA3B,CAAd,CAFgE,CAIhE;;AACA,cAAMyB,QAAQ,GAAG/D,QAAQ,CAACgE,YAAT;AAAA;AAAA,mCAAjB;;AACA,cAAID,QAAJ,EAAc;AACV,gBAAM0B,KAAK,GAAGhC,KAAK,CAACC,IAAN,CACV9D,QAAQ,CAACwB,WAAT,KAAyB,OAAzB,GACM;AAAA;AAAA,4CAAYtC,QAAZ,CAAqBK,SAArB,CAA+BgE,UAA/B,CAA0CQ,MAA1C,EADN,GAEM;AAAA;AAAA,4CAAY7E,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCK,MAAzC,EAHI,EAIZ+B,OAJY,CAIJ9F,QAJI,CAAd;AAKAmE,YAAAA,QAAQ,CAAC8B,IAAT,CAAcjG,QAAd,EAAwB6F,KAAxB,EAA+B7F,QAAQ,CAACwB,WAAxC;AACAnC,YAAAA,OAAO,CAACwC,GAAR,CAAY,gBAAZ,EAA8B7B,QAA9B;AACH,WAd+D,CAgBhE;;;AACA,cAAMkG,SAAS,GAAG,CAACC,IAAD,EAAeC,WAAf,KAA4C;AAC1D,gBAAMC,IAAI,GAAGjG,QAAQ,CAACkG,cAAT,CAAwBH,IAAxB,CAAb;;AACA,gBAAIE,IAAJ,EAAU;AACN,kBAAME,EAAE,GAAGF,IAAI,CAACjC,YAAL,CAAkBpG,MAAlB,CAAX;;AACA,kBAAIuI,EAAJ,EAAQ;AACJA,gBAAAA,EAAE,CAACH,WAAH,GAAiBA,WAAjB;AACAG,gBAAAA,EAAE,CAACC,KAAH,GAAW7I,KAAK,CAAC8I,KAAjB;AACH;AACJ;AACJ,WATD;;AAWAP,UAAAA,SAAS,CAAC,QAAD,EAAW,KAAKQ,eAAL,CAAqBjE,MAAM,CAACI,QAA5B,EAAsC,IAAtC,EAA4CkD,KAA5C,CAAX,CAAT;AACAG,UAAAA,SAAS,CAAC,UAAD,EAAa,KAAKQ,eAAL,CAAqBjE,MAAM,CAACI,QAA5B,EAAsC,KAAtC,EAA6CkD,KAA7C,CAAb,CAAT;;AAEA,cAAItD,MAAM,CAACC,QAAP,IAAmB,CAAnB,IAAwBD,MAAM,CAACC,QAAP,GAAkB,KAAKiE,WAAL,CAAiBrG,MAA/D,EAAuE;AACnE4F,YAAAA,SAAS,CAAC,MAAD,EAAS,KAAKS,WAAL,CAAiBlE,MAAM,CAACC,QAAxB,CAAT,CAAT;AACH;;AAEDtC,UAAAA,QAAQ,CAAC+F,IAAT,GAAmBnG,QAAQ,CAACwB,WAA5B,SAA2C;AAAA;AAAA,sCAAUoF,WAAV,CAAsBnE,MAAM,CAACC,QAA7B,EAAuCD,MAAM,CAACI,QAA9C,CAA3C;AACH;;AAEO6D,QAAAA,eAAe,CAACG,IAAD,EAAeC,KAAf,EAA+Bf,KAA/B,EAAmE;AACtF,cAAIc,IAAI,GAAG,CAAP,IAAYA,IAAI,GAAG,EAAvB,EAA2B,OAAO,IAAP;AAC3B,cAAME,GAAG,GAAGD,KAAK,GACVf,KAAK,GAAG,KAAKiB,aAAR,GAAwB,KAAKC,eADxB,GAEVlB,KAAK,GAAG,KAAKmB,eAAR,GAA0B,KAAKC,iBAF3C;AAGA,iBAAOJ,GAAG,CAACF,IAAD,CAAH,IAAa,IAApB;AACH,SAvXkD,CAyXnD;;AAEA;AACJ;AACA;AACA;;;AACWtC,QAAAA,gBAAgB,CAACnE,QAAD,EAAuB;AAC1C,cAAMJ,QAAQ,GAAG,KAAKiD,mBAAL,CAAyB7C,QAAzB,CAAjB;AACA,cAAI,CAACJ,QAAD,IAAaA,QAAQ,CAACwB,WAAT,KAAyB,OAA1C,EAAmD,OAFT,CAI1C;;AACA,eAAK4F,eAAL,CAAqBhH,QAArB,EAA+BJ,QAA/B;AACH;AAED;AACJ;AACA;AACA;;;AACWgF,QAAAA,eAAe,CAAC5E,QAAD,EAAuB;AACzC,cAAMJ,QAAQ,GAAG,KAAKiD,mBAAL,CAAyB7C,QAAzB,CAAjB;AACA,cAAI,CAACJ,QAAD,IAAaA,QAAQ,CAACwB,WAAT,KAAyB,MAA1C,EAAkD,OAFT,CAIzC;;AACA,eAAK4F,eAAL,CAAqBhH,QAArB,EAA+BJ,QAA/B;AACH;AAED;AACJ;AACA;AACA;AACA;;;AACYoH,QAAAA,eAAe,CAAChH,QAAD,EAAiBJ,QAAjB,EAA4C;AAC/D;AACA,cAAMY,cAAc,GAAG;AAAA;AAAA,0CAAY1B,QAAZ,CAAqBK,SAArB,CAA+BsB,OAAtD;AACA,cAAMC,YAAY,GAAG;AAAA;AAAA,0CAAY5B,QAAZ,CAAqBK,SAArB,CAA+BuB,YAApD,CAH+D,CAK/D;;AACA,cAAIF,cAAJ,EAAoB;AAChB,gBAAMyG,WAAW,GAAG,KAAK7E,WAAL,CAAiB5B,cAAc,CAAC6B,MAAf,CAAsBC,QAAvC,CAApB;AACA,gBAAM4E,WAAW,GAAG,KAAK1E,WAAL,CAAiBhC,cAAc,CAAC6B,MAAf,CAAsBI,QAAvC,CAApB;AACAxD,YAAAA,OAAO,CAACwC,GAAR,gCAAqBwF,WAArB,GAAmCC,WAAnC;AACH,WAJD,MAIO;AACHjI,YAAAA,OAAO,CAACwC,GAAR;AACH,WAZ8D,CAc/D;;;AACAxC,UAAAA,OAAO,CAACwC,GAAR,sCAAsBf,YAAY,CAACR,MAAnC;AACAQ,UAAAA,YAAY,CAACiC,OAAb,CAAqB,CAAC9B,IAAD,EAAO4E,KAAP,KAAiB;AAClC,gBAAMtD,QAAQ,GAAG,KAAKC,WAAL,CAAiBvB,IAAI,CAACwB,MAAL,CAAYC,QAA7B,CAAjB;AACA,gBAAMC,QAAQ,GAAG,KAAKC,WAAL,CAAiB3B,IAAI,CAACwB,MAAL,CAAYI,QAA7B,CAAjB;AACAxD,YAAAA,OAAO,CAACwC,GAAR,yBAAmBgE,KAAnB,WAA8BtD,QAA9B,GAAyCI,QAAzC;AACH,WAJD,EAhB+D,CAsB/D;;AACA,cAAI3C,QAAQ,CAACwB,WAAT,KAAyB,MAA7B,EAAqC;AACjC;AACA,gBAAIxB,QAAQ,KAAKY,cAAjB,EAAiC;AAC7B;AACA,kBAAM2G,SAAS,GAAGzG,YAAY,CAACgF,OAAb,CAAqB9F,QAArB,CAAlB;AACAX,cAAAA,OAAO,CAACwC,GAAR,wDAAyB0F,SAAzB,0CAA8CzG,YAAY,CAACR,MAA3D;;AACA,kBAAIiH,SAAS,KAAKzG,YAAY,CAACR,MAAb,GAAsB,CAAxC,EAA2C;AACvCjB,gBAAAA,OAAO,CAACwC,GAAR;AACA;AACH,eAP4B,CAS7B;;;AACAxC,cAAAA,OAAO,CAACwC,GAAR,sCAAsB,KAAKW,WAAL,CAAiBxC,QAAQ,CAACyC,MAAT,CAAgBC,QAAjC,CAAtB,GAAmE,KAAKE,WAAL,CAAiB5C,QAAQ,CAACyC,MAAT,CAAgBI,QAAjC,CAAnE;AACA;AAAA;AAAA,8CAAY3D,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,GAAyCb,QAAzC;;AACA,kBAAMuC,SAAQ,GAAG,KAAKC,WAAL,CAAiBxC,QAAQ,CAACyC,MAAT,CAAgBC,QAAjC,CAAjB;;AACA,kBAAMC,SAAQ,GAAG,KAAKC,WAAL,CAAiB5C,QAAQ,CAACyC,MAAT,CAAgBI,QAAjC,CAAjB;;AACAxD,cAAAA,OAAO,CAACwC,GAAR,gCAAqBU,SAArB,GAAgCI,SAAhC,EAd6B,CAgB7B;;AACA,kBAAM6E,mBAAmB,GAAG;AAAA;AAAA,8CAAYtI,QAAZ,CAAqBK,SAArB,CAA+BuB,YAA3D;AACA,kBAAM2G,UAAU,GAAGD,mBAAmB,CAAC1B,OAApB,CAA4B9F,QAA5B,CAAnB;;AACA,kBAAIyH,UAAU,KAAK,CAAC,CAApB,EAAuB;AACnBD,gBAAAA,mBAAmB,CAACE,MAApB,CAA2BD,UAA3B,EAAuC,CAAvC;AACApI,gBAAAA,OAAO,CAACwC,GAAR,2CAAqB4F,UAAU,GAAG,CAAlC,2BAAyCD,mBAAmB,CAAClH,MAA7D;AACH;AACJ;AACJ,WAjD8D,CAmD/D;;;AACA,cAAIN,QAAQ,CAACwB,WAAT,KAAyB,MAAzB,IAAmCZ,cAAvC,EAAuD;AACnD,gBAAM+G,OAAO,GAAG;AAAA;AAAA,4CAAYC,aAAZ,CAA0B5H,QAA1B,EAAoCY,cAApC,CAAhB;;AACA,gBAAI,CAAC+G,OAAL,EAAc;AACVtI,cAAAA,OAAO,CAACwC,GAAR;AACA;AACH;AACJ,WA1D8D,CA4D/D;;;AACA,cAAM5B,cAAc,GAAG,KAAK4H,uBAAL,CAA6B7H,QAA7B,CAAvB,CA7D+D,CA+D/D;;AACA,cAAMuC,QAAQ,GAAG,KAAKC,WAAL,CAAiBxC,QAAQ,CAACyC,MAAT,CAAgBC,QAAjC,CAAjB;AACA,cAAMC,QAAQ,GAAG,KAAKC,WAAL,CAAiB5C,QAAQ,CAACyC,MAAT,CAAgBI,QAAjC,CAAjB;AACA,cAAMiF,QAAQ,GAAG9H,QAAQ,CAACwB,WAAT,KAAyB,OAAzB,GAAmC,IAAnC,GAA0C,IAA3D;AACAnC,UAAAA,OAAO,CAACwC,GAAR,kBAAiBiG,QAAjB,sBAAgCvF,QAAhC,GAA2CI,QAA3C,EAnE+D,CAqE/D;;AACA,eAAK5C,kBAAL,CAAwBC,QAAxB,EAAkCC,cAAlC,EAtE+D,CAwE/D;;AACA,cAAID,QAAQ,CAACwB,WAAT,KAAyB,OAA7B,EAAsC;AAClC;AAAA;AAAA,4CAAYtC,QAAZ,CAAqBK,SAArB,CAA+BsB,OAA/B,GAAyCb,QAAzC;;AACA,gBAAMuC,UAAQ,GAAG,KAAKC,WAAL,CAAiBxC,QAAQ,CAACyC,MAAT,CAAgBC,QAAjC,CAAjB;;AACA,gBAAMC,UAAQ,GAAG,KAAKC,WAAL,CAAiB5C,QAAQ,CAACyC,MAAT,CAAgBI,QAAjC,CAAjB;;AACAxD,YAAAA,OAAO,CAACwC,GAAR,4CAAuBU,UAAvB,GAAkCI,UAAlC;AACH,WA9E8D,CAgF/D;;;AACA3C,UAAAA,QAAQ,CAACkD,cAAT,CAAwBjD,cAAc,CAACmB,CAAvC,EAA0CnB,cAAc,CAACoB,CAAzD,EAjF+D,CAmF/D;;AACAjB,UAAAA,QAAQ,CAAC+C,eAAT,CAAyB,GAAzB;AACAnD,UAAAA,QAAQ,CAAC0B,MAAT,GAAkB,GAAlB,CArF+D,CAuF/D;;AACAxD,UAAAA,KAAK,CAACkC,QAAD,CAAL,CACK8B,EADL,CACQ,GADR,EACa;AAAEC,YAAAA,QAAQ,EAAE,IAAIhE,IAAJ,CAAS8B,cAAc,CAACmB,CAAxB,EAA2BnB,cAAc,CAACoB,CAA1C,EAA6C,CAA7C;AAAZ,WADb,EAEKe,IAFL,CAEU,MAAM;AACR;AACA,gBAAM2F,UAAU,GAAG;AAAA;AAAA,4CAAY7I,QAAZ,CAAqBK,SAArB,CAA+BsB,OAAlD;;AACA,gBAAIkH,UAAJ,EAAgB;AACZ1I,cAAAA,OAAO,CAACwC,GAAR,gCAAqB,KAAKW,WAAL,CAAiBuF,UAAU,CAACtF,MAAX,CAAkBC,QAAnC,CAArB,GAAoE,KAAKE,WAAL,CAAiBmF,UAAU,CAACtF,MAAX,CAAkBI,QAAnC,CAApE;AACH,aAFD,MAEO;AACHxD,cAAAA,OAAO,CAACwC,GAAR;AACH;AACJ,WAVL,EAWKmB,KAXL;AAYH;AAED;AACJ;AACA;;;AACYgF,QAAAA,aAAa,GAAS;AAC1B,cAAMpH,cAAc,GAAG;AAAA;AAAA,0CAAY1B,QAAZ,CAAqBK,SAArB,CAA+BsB,OAAtD;;AACA,cAAID,cAAJ,EAAoB;AAChBvB,YAAAA,OAAO,CAACwC,GAAR,gCAAqB,KAAKW,WAAL,CAAiB5B,cAAc,CAAC6B,MAAf,CAAsBC,QAAvC,CAArB,GAAwE,KAAKE,WAAL,CAAiBhC,cAAc,CAAC6B,MAAf,CAAsBI,QAAvC,CAAxE;AACH,WAFD,MAEO;AACHxD,YAAAA,OAAO,CAACwC,GAAR;AACH;AACJ;AAED;AACJ;AACA;AACA;AACA;;;AACYgG,QAAAA,uBAAuB,CAAC7H,QAAD,EAAgD;AAAA;;AAC3E,cAAMsD,YAAY,GAAG;AAAA;AAAA,wCAAWpE,QAAX,CAAoBoE,YAAzC;AACA,cAAM2B,QAAQ,GAAG3B,YAAH,oBAAGA,YAAY,CAAE4B,UAA/B,CAF2E,CAI3E;;AACA,cAAMxB,SAAS,GAAGG,KAAK,CAACC,IAAN,CAAW;AAAA;AAAA,0CAAY5E,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCK,MAAzC,EAAX,CAAlB;AACA,cAAMkE,YAAY,GAAGvE,SAAS,CAACA,SAAS,CAACpD,MAAV,GAAmB,CAApB,CAA9B;;AAEA,cAAI2H,YAAJ,EAAkB;AACd;AACA,gBAAM/H,QAAQ,GAAG,KAAKC,SAAL,CAAeD,QAAhC;;AACA,iBAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,QAAQ,CAACI,MAA7B,EAAqCD,CAAC,EAAtC,EAA0C;AACtC,kBAAME,KAAK,GAAGL,QAAQ,CAACG,CAAD,CAAtB;AACA,kBAAMG,MAAM,GAAID,KAAD,CAAeC,MAA9B;;AAEA,kBAAIA,MAAM,KAAKyH,YAAY,CAACxH,EAA5B,EAAgC;AAC5B;AACA;AACA,oBAAM0B,QAAQ,GAAG5B,KAAK,CAACI,WAAN,EAAjB;AAEAtB,gBAAAA,OAAO,CAACwC,GAAR,yDAA0BM,QAAQ,CAACf,CAAnC,UAAyCe,QAAQ,CAACd,CAAlD;AAEA,uBAAO;AAAED,kBAAAA,CAAC,EAAEe,QAAQ,CAACf,CAAd;AAAiBC,kBAAAA,CAAC,EAAEc,QAAQ,CAACd;AAA7B,iBAAP;AACH;AACJ;;AAEDhC,YAAAA,OAAO,CAACwC,GAAR,CAAY,cAAZ;AACH,WA3B0E,CA6B3E;;;AACA,iBAAO;AACHT,YAAAA,CAAC,4BAAE6D,QAAF,oBAAEA,QAAQ,CAAES,aAAZ,qCAA6B,GAD3B;AAEHrE,YAAAA,CAAC,4BAAE4D,QAAF,oBAAEA,QAAQ,CAAEW,aAAZ,qCAA6B;AAF3B,WAAP;AAIH;AAED;AACJ;AACA;;;AACYpD,QAAAA,WAAW,CAAC0F,IAAD,EAAuB;AACtC,cAAMC,KAAK,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,GAAhB,CAAd;AACA,iBAAOA,KAAK,CAACD,IAAD,CAAL,IAAe,GAAtB;AACH;AAED;AACJ;AACA;;;AACYtF,QAAAA,WAAW,CAACiE,IAAD,EAAuB;AACtC,cAAMuB,KAAK,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,GAAhB,EAAqB,GAArB,EAA0B,GAA1B,EAA+B,GAA/B,EAAoC,GAApC,EAAyC,GAAzC,EAA8C,IAA9C,EAAoD,GAApD,EAAyD,GAAzD,EAA8D,GAA9D,CAAd;AACA,iBAAOA,KAAK,CAACvB,IAAD,CAAL,IAAe,GAAtB;AACH;AAED;AACJ;AACA;;;AACWwB,QAAAA,WAAW,GAAS;AACvB,cAAMjJ,OAAO,GAAG;AAAA;AAAA,0CAAYF,QAAZ,CAAqBoJ,IAArB,EAAhB;;AACA,cAAIlJ,OAAJ,EAAa;AACTC,YAAAA,OAAO,CAACwC,GAAR,CAAY,OAAZ,EADS,CAET;;AACA,iBAAK0G,sBAAL,GAHS,CAIT;;AACA,iBAAKP,aAAL;AACH,WAND,MAMO;AACH3I,YAAAA,OAAO,CAACwC,GAAR,CAAY,MAAZ;AACH;AACJ;AAED;AACJ;AACA;;;AACYoB,QAAAA,mBAAmB,CAAC7C,QAAD,EAAwC;AAC/D,cAAMI,MAAM,GAAIJ,QAAD,CAAkBI,MAAjC;;AAEA,cAAI,CAACA,MAAL,EAAa;AACTnB,YAAAA,OAAO,CAACwC,GAAR,CAAY,eAAZ;AACA,mBAAO2G,SAAP;AACH;;AAED,cAAMxI,QAAQ,GAAG;AAAA;AAAA,0CAAYd,QAAZ,CAAqBK,SAArB,CAA+B+C,WAA/B,CAA2C9B,MAA3C,CAAjB;AAEA,iBAAOR,QAAP;AACH;AAED;AACJ;AACA;;;AACYyI,QAAAA,kBAAkB,CAACrI,QAAD,EAAiBJ,QAAjB,EAA4C;AAClE,eAAKiE,gBAAL,CAAsB7D,QAAtB,EAAgCJ,QAAhC;AACH;AAED;AACJ;AACA;;;AACY0I,QAAAA,sBAAsB,GAAS;AACnC,cAAMC,QAAQ,GAAG;AAAA;AAAA,0CAAYzJ,QAAZ,CAAqBK,SAArB,CAA+BqJ,eAA/B,EAAjB;;AACA,cAAID,QAAJ,EAAc;AACV;AACA,gBAAMzI,QAAQ,GAAG,KAAKC,SAAL,CAAeD,QAAhC;;AACA,iBAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,QAAQ,CAACI,MAA7B,EAAqCD,CAAC,EAAtC,EAA0C;AACtC,kBAAME,KAAK,GAAGL,QAAQ,CAACG,CAAD,CAAtB;AACA,kBAAMG,MAAM,GAAID,KAAD,CAAeC,MAA9B;;AAEA,kBAAIA,MAAM,KAAKmI,QAAQ,CAAClI,EAAxB,EAA4B;AACxBF,gBAAAA,KAAK,CAACsI,gBAAN;AACA;AACH;AACJ;AACJ;AACJ;AAED;AACJ;AACA;;;AACYC,QAAAA,uBAAuB,GAAS;AACpC;AACA,cAAM5I,QAAQ,GAAG,KAAKC,SAAL,CAAeD,QAAhC;;AACA,eAAK,IAAIG,CAAC,GAAGH,QAAQ,CAACI,MAAT,GAAkB,CAA/B,EAAkCD,CAAC,IAAI,CAAvC,EAA0CA,CAAC,EAA3C,EAA+C;AAC3C,gBAAME,KAAK,GAAGL,QAAQ,CAACG,CAAD,CAAtB;AACA,gBAAMG,MAAM,GAAID,KAAD,CAAeC,MAA9B;AACA,gBAAMR,QAAQ,GAAG;AAAA;AAAA,4CAAYd,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCqF,GAAzC,CAA6CvI,MAA7C,CAAjB,CAH2C,CAK3C;;AACA,gBAAIR,QAAJ,EAAc;AACVO,cAAAA,KAAK,CAACsI,gBAAN;AACH;AACJ,WAZmC,CAcpC;;;AACA,cAAMpF,cAAc,GAAG;AAAA;AAAA,0CAAYvE,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCC,IAAhE;AACA,cAAML,YAAY,GAAG;AAAA;AAAA,wCAAWpE,QAAX,CAAoBoE,YAAzC;AAEA;AAAA;AAAA,0CAAYpE,QAAZ,CAAqBK,SAArB,CAA+BmE,SAA/B,CAAyCX,OAAzC,CAAkD/C,QAAD,IAAc;AAC3D,iBAAK4D,cAAL,CAAoB5D,QAApB,EAA8BsD,YAA9B,EAA4CG,cAA5C;AACH,WAFD;AAGH;AAED;AACJ;AACA;;;AACY8E,QAAAA,sBAAsB,GAAS;AACnC,eAAKvJ,mBAAL;AACH;;AA7pBkD,O;;;;;iBAEZ,I;;;;;;;iBACL,I;;;;;;;iBACC,I;;;;;;;iBAGqB,E;;;;;;;iBAGE,E;;;;;;;iBACA,E;;;;;;;iBACE,E;;;;;;;iBACN,E","sourcesContent":["import { _decorator, Color, Component, instantiate, Node, Prefab, Sprite, SpriteFrame, tween, Vec3 } from 'cc';\r\nimport { GameConfig } from '../../resources/configs/GameConfig';\r\nimport { DataManager } from '../managers/DataManager';\r\nimport { CardModel } from '../models/CardModel';\r\nimport { CardService } from '../services/CardService';\r\nimport { CardUtils } from '../utils/CardUtils';\r\nimport CardView from '../views/CardView';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n// 卡牌移动记录接口\r\ninterface CardMoveRecord {\r\n    cardId: string;\r\n    fromPosition: { x: number, y: number };\r\n    toPosition: { x: number, y: number };\r\n    fromArea: string;\r\n    toArea: string;\r\n    zIndex: number;\r\n    // 记录移动前的顶牌ID\r\n    previousTopCardId: string | null;\r\n    // 记录移动前的备用牌ID列表\r\n    previousReserveCardIds: string[];\r\n}\r\n\r\n@ccclass('LevelController')\r\nexport default class LevelController extends Component {\r\n    // --- 属性定义 ---\r\n    @property(Prefab) cardPrefab: Prefab = null;\r\n    @property(Node) tableArea: Node = null;\r\n    @property(Node) undoButton: Node = null;\r\n\r\n    // --- 资源引用 ---\r\n    @property([SpriteFrame]) bigRedNumbers: SpriteFrame[] = [];\r\n\r\n    // --- 游戏状态 ---\r\n    @property([SpriteFrame]) bigBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallRedNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) smallBlackNumbers: SpriteFrame[] = [];\r\n    @property([SpriteFrame]) suitSprites: SpriteFrame[] = [];\r\n\r\n    // --- 历史记录 ---\r\n    private historyStack: CardMoveRecord[] = [];\r\n\r\n    async onLoad() {\r\n        // 1. 初始化配置\r\n        await this.initializeConfig();\r\n        // 2. 加载关卡\r\n        await this.loadLevel();\r\n        // 3. 创建卡牌视图\r\n        this.createCardsFromData();\r\n        // 4. 设置回退按钮\r\n        this.setupUndoButton();\r\n    }\r\n\r\n    private async initializeConfig(): Promise<void> {\r\n        await GameConfig.instance.initialize();\r\n    }\r\n\r\n    private async loadLevel(): Promise<void> {\r\n        const success = await DataManager.instance.loadLevel(1);\r\n        if (!success) {\r\n            console.error('加载关卡失败');\r\n        } else {\r\n            // 加载关卡成功后，更新顶牌和备用牌\r\n            DataManager.instance.gameModel.updateTopAndReserveCards();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 设置回退按钮\r\n     */\r\n    private setupUndoButton(): void {\r\n        if (!this.undoButton) {\r\n            console.warn('回退按钮未设置');\r\n            return;\r\n        }\r\n\r\n        this.undoButton.on(Node.EventType.TOUCH_END, () => {\r\n            this.undoLastMove();\r\n        }, this);\r\n    }\r\n\r\n    /**\r\n     * 保存卡牌移动记录\r\n     * @param cardData 卡牌数据\r\n     * @param targetPosition 目标位置\r\n     */\r\n    private saveCardMoveRecord(cardData: CardModel, targetPosition: { x: number, y: number }): void {\r\n        // 找到对应的卡牌节点\r\n        const children = this.tableArea.children;\r\n        let cardNode: Node | null = null;\r\n        for (let i = 0; i < children.length; i++) {\r\n            const child = children[i];\r\n            const cardId = (child as any).cardId;\r\n            if (cardId === cardData.id) {\r\n                cardNode = child;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (!cardNode) {\r\n            console.error(`未找到卡牌节点: ${cardData.id}`);\r\n            return;\r\n        }\r\n\r\n        // 获取卡牌节点的当前位置\r\n        const currentPosition = cardNode.getPosition();\r\n\r\n        // 获取当前顶牌\r\n        const currentTopCard = DataManager.instance.gameModel.topCard;\r\n        const reserveCards = DataManager.instance.gameModel.reserveCards;\r\n        \r\n        // 记录备用牌的ID列表\r\n        const previousReserveCardIds = reserveCards.map(card => card.id);\r\n\r\n        const record: CardMoveRecord = {\r\n            cardId: cardData.id,\r\n            fromPosition: { x: currentPosition.x, y: currentPosition.y },\r\n            toPosition: { x: targetPosition.x, y: targetPosition.y },\r\n            fromArea: cardData.currentArea,\r\n            toArea: cardData.currentArea, // 暂时保持不变，因为现在所有卡牌都在tableArea中\r\n            zIndex: cardData.zIndex,\r\n            previousTopCardId: currentTopCard ? currentTopCard.id : null,\r\n            previousReserveCardIds: previousReserveCardIds\r\n        };\r\n\r\n        this.historyStack.push(record);\r\n    }\r\n\r\n    /**\r\n     * 回退最后一次移动\r\n     */\r\n    private undoLastMove(): void {\r\n        if (this.historyStack.length === 0) {\r\n            console.log('没有可回退的移动');\r\n            return;\r\n        }\r\n\r\n        const lastRecord = this.historyStack.pop();\r\n        if (!lastRecord) return;\r\n\r\n        console.log('回退卡牌移动:', lastRecord);\r\n\r\n        // 找到对应的卡牌节点\r\n        const children = this.tableArea.children;\r\n        for (let i = 0; i < children.length; i++) {\r\n            const child = children[i];\r\n            const cardId = (child as any).cardId;\r\n\r\n            if (cardId === lastRecord.cardId) {\r\n                // fromPosition已经是卡牌节点的当前位置（相对坐标）\r\n                // 不需要再做任何转换，直接使用即可\r\n                const targetX = lastRecord.fromPosition.x;\r\n                const targetY = lastRecord.fromPosition.y;\r\n\r\n                // 使用tween动画移动卡牌回退\r\n                tween(child)\r\n                    .to(0.3, { position: new Vec3(targetX, targetY, 0) })\r\n                    .call(() => {\r\n                        // 动画完成后恢复顶牌\r\n                        if (lastRecord.previousTopCardId) {\r\n                            const previousTopCard = DataManager.instance.gameModel.getCardById(lastRecord.previousTopCardId);\r\n                            if (previousTopCard) {\r\n                                DataManager.instance.gameModel.topCard = previousTopCard;\r\n                                const suitName = this.getSuitName(previousTopCard.config.CardSuit);\r\n                                const faceName = this.getFaceName(previousTopCard.config.CardFace);\r\n                                console.log(`恢复顶牌: ${suitName}${faceName}`);\r\n                            }\r\n                        } else {\r\n                            // 如果没有之前的顶牌，设置为null\r\n                            DataManager.instance.gameModel.topCard = null;\r\n                            console.log('恢复顶牌: 无');\r\n                        }\r\n                        \r\n                        // 恢复备用牌数组\r\n                        if (lastRecord.previousReserveCardIds && lastRecord.previousReserveCardIds.length > 0) {\r\n                            const restoredReserveCards: CardModel[] = [];\r\n                            lastRecord.previousReserveCardIds.forEach(cardId => {\r\n                                const card = DataManager.instance.gameModel.getCardById(cardId);\r\n                                if (card) {\r\n                                    restoredReserveCards.push(card);\r\n                                }\r\n                            });\r\n                            DataManager.instance.gameModel.reserveCards = restoredReserveCards;\r\n                            console.log(`恢复备用牌数量: ${restoredReserveCards.length}`);\r\n                        } else {\r\n                            DataManager.instance.gameModel.reserveCards = [];\r\n                            console.log('恢复备用牌数量: 0');\r\n                        }\r\n                    })\r\n                    .start();\r\n\r\n                // 更新卡牌数据的位置\r\n                const cardData = this.getCardDataFromNode(child);\r\n                if (cardData) {\r\n                    cardData.updatePosition(targetX, targetY);\r\n                    cardData.zIndex = lastRecord.zIndex;\r\n                }\r\n\r\n                // 更新层级\r\n                child.setSiblingIndex(lastRecord.zIndex);\r\n\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    private createCardsFromData(): void {\r\n        if (!this.cardPrefab) return;\r\n\r\n        this.tableArea.removeAllChildren();\r\n\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        // 1. 创建桌面牌\r\n        DataManager.instance.gameModel.tableCards.forEach((cardData) => {\r\n            this.createTableCard(cardData, layoutConfig);\r\n        });\r\n\r\n        // 2. 创建手牌\r\n        const totalHandCards = DataManager.instance.gameModel.handCards.size;\r\n        DataManager.instance.gameModel.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n\r\n        // 3. 设置初始顶牌（手牌区最右边的一张）\r\n        const handCards = Array.from(DataManager.instance.gameModel.handCards.values());\r\n        if (handCards.length > 0) {\r\n            DataManager.instance.gameModel.topCard = handCards[handCards.length - 1];\r\n            console.log(`初始顶牌: ${this.getSuitName(DataManager.instance.gameModel.topCard.config.CardSuit)}${this.getFaceName(DataManager.instance.gameModel.topCard.config.CardFace)}`);\r\n        }\r\n    }\r\n\r\n    // --- 创建桌面牌 ---\r\n    private createTableCard(cardData: CardModel, layoutConfig: any): void {\r\n        console.log('创建桌面牌:', cardData);\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n\r\n        // 将cardId存储到节点属性上\r\n        (cardNode as any).cardId = cardData.id;\r\n        console.log('已将cardId存储到节点属性:', cardData.id);\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n        this.setupTableCardPosition(cardNode, cardData, layoutConfig);\r\n\r\n        // 设置点击回调\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            cardView.setClickCallback((view: CardView) => {\r\n                this.onTableCardClick(cardNode);\r\n            });\r\n            console.log('桌面卡牌点击回调已设置');\r\n        } else {\r\n            console.error('未找到CardView组件！');\r\n        }\r\n    }\r\n\r\n    // --- 设置桌面牌位置 ---\r\n    private setupTableCardPosition(\r\n        cardNode: Node,\r\n        cardData: CardModel,\r\n        layoutConfig: any\r\n    ): void {\r\n        // 使用CardUtils.convertAbsoluteToRelativeForTable来转换坐标（往上偏移300像素）\r\n        const relativePos = CardUtils.convertAbsoluteToRelativeForTable(\r\n            cardData.position.x,\r\n            cardData.position.y\r\n        );\r\n\r\n        const posX = relativePos.x;\r\n        const posY = relativePos.y;\r\n        const zIndex = cardData.zIndex;\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(zIndex);\r\n\r\n        console.log(`桌面牌位置: (${posX}, ${posY})`);\r\n    }\r\n\r\n    // --- 创建手牌 ---\r\n    private createHandCard(cardData: CardModel, layoutConfig: any, totalCards: number): void {\r\n        console.log('创建手牌:', cardData);\r\n        const cardNode = instantiate(this.cardPrefab);\r\n        this.tableArea.addChild(cardNode);\r\n\r\n        // 将cardId存储到节点属性上\r\n        (cardNode as any).cardId = cardData.id;\r\n        console.log('已将cardId存储到节点属性:', cardData.id);\r\n\r\n        this.setupCardDisplay(cardNode, cardData);\r\n        this.setupHandCardPosition(cardNode, cardData, layoutConfig, totalCards);\r\n\r\n        // 设置点击回调\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            cardView.setClickCallback((view: CardView) => {\r\n                console.log('点击了手牌:', view.getCardData());\r\n                this.onHandCardClick(cardNode);\r\n            });\r\n            console.log('手牌点击回调已设置');\r\n        } else {\r\n            console.error('未找到CardView组件！');\r\n        }\r\n    }\r\n\r\n    // --- 设置手牌位置 ---\r\n    private setupHandCardPosition(\r\n        cardNode: Node,\r\n        cardData: CardModel,\r\n        layoutConfig: any,\r\n        totalCards: number\r\n    ): void {\r\n        const handConf = layoutConfig?.handLayout || {};\r\n\r\n        // 读取配置参数 (带有默认值，保证绝对能显示出来)\r\n        const stackX = handConf.stackStartX ?? -350;\r\n        const startY = handConf.stackStartY ?? 0;\r\n        const spacingX = handConf.stackSpacingX ?? 100;\r\n\r\n        // 右侧单张的位置\r\n        const separateX = handConf.separateCardX ?? 200;\r\n        const separateY = handConf.separateCardY ?? startY;\r\n\r\n        // 获取当前卡牌的索引\r\n        const index = Array.from(DataManager.instance.gameModel.handCards.values()).indexOf(cardData);\r\n\r\n        let posX = 0;\r\n        let posY = startY;\r\n        let zIndex = index;\r\n\r\n        // --- 核心逻辑：判断是否是最后一张 ---\r\n        if (index === totalCards - 1) {\r\n            // 是最后一张 -> 放在右边固定位置\r\n            posX = separateX;\r\n            posY = separateY;\r\n            zIndex = 100; // 放在最上层\r\n        } else {\r\n            // 是前面的牌 -> 左边堆叠\r\n            // 公式：起始X + (当前索引 * 间距)\r\n            posX = stackX + (index * spacingX);\r\n            posY = startY;\r\n            zIndex = index; // 正常层级\r\n        }\r\n\r\n        cardNode.setPosition(posX, posY, 0);\r\n        cardNode.setSiblingIndex(zIndex);\r\n\r\n        // 更新卡牌数据的位置\r\n        cardData.updatePosition(posX, posY);\r\n        cardData.zIndex = zIndex;\r\n\r\n        console.log(`手牌 ${index} 位置: (${posX}, ${posY})`);\r\n    }\r\n\r\n    // --- 通用显示设置 ---\r\n    private setupCardDisplay(cardNode: Node, cardData: CardModel): void {\r\n        const config = cardData.config;\r\n        const isRed = CardUtils.isRedSuit(config.CardSuit);\r\n\r\n        // 初始化CardView\r\n        const cardView = cardNode.getComponent(CardView);\r\n        if (cardView) {\r\n            const index = Array.from(\r\n                cardData.currentArea === 'table' \r\n                    ? DataManager.instance.gameModel.tableCards.values()\r\n                    : DataManager.instance.gameModel.handCards.values()\r\n            ).indexOf(cardData);\r\n            cardView.init(cardData, index, cardData.currentArea);\r\n            console.log('CardView初始化完成:', cardData);\r\n        }\r\n\r\n        // 辅助函数：安全设置图片\r\n        const setSprite = (name: string, spriteFrame: SpriteFrame) => {\r\n            const node = cardNode.getChildByName(name);\r\n            if (node) {\r\n                const sp = node.getComponent(Sprite);\r\n                if (sp) {\r\n                    sp.spriteFrame = spriteFrame;\r\n                    sp.color = Color.WHITE;\r\n                }\r\n            }\r\n        };\r\n\r\n        setSprite('bigNum', this.getNumberSprite(config.CardFace, true, isRed));\r\n        setSprite('smallNum', this.getNumberSprite(config.CardFace, false, isRed));\r\n\r\n        if (config.CardSuit >= 0 && config.CardSuit < this.suitSprites.length) {\r\n            setSprite('suit', this.suitSprites[config.CardSuit]);\r\n        }\r\n\r\n        cardNode.name = `${cardData.currentArea}_${CardUtils.getCardName(config.CardSuit, config.CardFace)}`;\r\n    }\r\n\r\n    private getNumberSprite(face: number, isBig: boolean, isRed: boolean): SpriteFrame | null {\r\n        if (face < 0 || face > 12) return null;\r\n        const arr = isBig\r\n            ? (isRed ? this.bigRedNumbers : this.bigBlackNumbers)\r\n            : (isRed ? this.smallRedNumbers : this.smallBlackNumbers);\r\n        return arr[face] || null;\r\n    }\r\n\r\n    // --- 游戏操作 ---\r\n\r\n    /**\r\n     * 处理桌面卡牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     */\r\n    public onTableCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'table') return;\r\n\r\n        // 统一处理卡牌点击\r\n        this.handleCardClick(cardNode, cardData);\r\n    }\r\n\r\n    /**\r\n     * 处理手牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     */\r\n    public onHandCardClick(cardNode: Node): void {\r\n        const cardData = this.getCardDataFromNode(cardNode);\r\n        if (!cardData || cardData.currentArea !== 'hand') return;\r\n\r\n        // 统一处理卡牌点击\r\n        this.handleCardClick(cardNode, cardData);\r\n    }\r\n\r\n    /**\r\n     * 统一处理卡牌点击事件\r\n     * @param cardNode 卡牌节点\r\n     * @param cardData 卡牌数据\r\n     */\r\n    private handleCardClick(cardNode: Node, cardData: CardModel): void {\r\n        // 获取当前顶牌\r\n        const currentTopCard = DataManager.instance.gameModel.topCard;\r\n        const reserveCards = DataManager.instance.gameModel.reserveCards;\r\n\r\n        // 打印当前顶牌信息\r\n        if (currentTopCard) {\r\n            const topSuitName = this.getSuitName(currentTopCard.config.CardSuit);\r\n            const topFaceName = this.getFaceName(currentTopCard.config.CardFace);\r\n            console.log(`当前顶牌: ${topSuitName}${topFaceName}`);\r\n        } else {\r\n            console.log(`当前顶牌: 无`);\r\n        }\r\n\r\n        // 打印备用牌信息\r\n        console.log(`备用牌数量: ${reserveCards.length}`);\r\n        reserveCards.forEach((card, index) => {\r\n            const suitName = this.getSuitName(card.config.CardSuit);\r\n            const faceName = this.getFaceName(card.config.CardFace);\r\n            console.log(`备用牌[${index}]: ${suitName}${faceName}`);\r\n        });\r\n\r\n        // 如果是手牌区的牌，检查是否是最右边的一张备用牌\r\n        if (cardData.currentArea === 'hand') {\r\n            // 检查点击的牌是否是最右边的一张备用牌（不是顶牌）\r\n            if (cardData !== currentTopCard) {\r\n                // 检查是否是备用牌中最右边的一张\r\n                const cardIndex = reserveCards.indexOf(cardData);\r\n                console.log(`点击的备用牌索引: ${cardIndex}, 备用牌数量: ${reserveCards.length}`);\r\n                if (cardIndex !== reserveCards.length - 1) {\r\n                    console.log(`只能点击备用牌中最右边的一张`);\r\n                    return;\r\n                }\r\n\r\n                // 点击的是备用牌，更新顶牌为这张备用牌\r\n                console.log(`使用备用牌: ${this.getSuitName(cardData.config.CardSuit)}${this.getFaceName(cardData.config.CardFace)}`);\r\n                DataManager.instance.gameModel.topCard = cardData;\r\n                const suitName = this.getSuitName(cardData.config.CardSuit);\r\n                const faceName = this.getFaceName(cardData.config.CardFace);\r\n                console.log(`更新顶牌: ${suitName}${faceName}`);\r\n                \r\n                // 从备用牌数组中移除被使用的备用牌\r\n                const currentReserveCards = DataManager.instance.gameModel.reserveCards;\r\n                const cardIndex2 = currentReserveCards.indexOf(cardData);\r\n                if (cardIndex2 !== -1) {\r\n                    currentReserveCards.splice(cardIndex2, 1);\r\n                    console.log(`备用牌数量从${cardIndex2 + 1}减少到${currentReserveCards.length}`);\r\n                }\r\n            }\r\n        }\r\n\r\n        // 如果不是手牌区的牌，检查点数是否可以连接\r\n        if (cardData.currentArea !== 'hand' && currentTopCard) {\r\n            const canMove = CardService.canMoveToCard(cardData, currentTopCard);\r\n            if (!canMove) {\r\n                console.log(`卡牌点数不匹配，无法移动`);\r\n                return;\r\n            }\r\n        }\r\n\r\n        // 计算目标位置\r\n        const targetPosition = this.calculateTargetPosition(cardData);\r\n\r\n        // 打印卡牌信息和目标位置\r\n        const suitName = this.getSuitName(cardData.config.CardSuit);\r\n        const faceName = this.getFaceName(cardData.config.CardFace);\r\n        const areaName = cardData.currentArea === 'table' ? '桌面' : '手牌';\r\n        console.log(`点击${areaName}卡牌: ${suitName}${faceName}`);\r\n\r\n        // 保存当前状态到历史记录\r\n        this.saveCardMoveRecord(cardData, targetPosition);\r\n\r\n        // 如果是桌牌，立即更新顶牌\r\n        if (cardData.currentArea === 'table') {\r\n            DataManager.instance.gameModel.topCard = cardData;\r\n            const suitName = this.getSuitName(cardData.config.CardSuit);\r\n            const faceName = this.getFaceName(cardData.config.CardFace);\r\n            console.log(`立即更新顶牌: ${suitName}${faceName}`);\r\n        }\r\n\r\n        // 更新卡牌数据的位置\r\n        cardData.updatePosition(targetPosition.x, targetPosition.y);\r\n\r\n        // 更新层级到最上层\r\n        cardNode.setSiblingIndex(100);\r\n        cardData.zIndex = 100;\r\n\r\n        // 使用tween动画移动卡牌\r\n        tween(cardNode)\r\n            .to(0.3, { position: new Vec3(targetPosition.x, targetPosition.y, 0) })\r\n            .call(() => {\r\n                // 动画完成后打印更新后的顶牌信息\r\n                const newTopCard = DataManager.instance.gameModel.topCard;\r\n                if (newTopCard) {\r\n                    console.log(`更新顶牌: ${this.getSuitName(newTopCard.config.CardSuit)}${this.getFaceName(newTopCard.config.CardFace)}`);\r\n                } else {\r\n                    console.log(`更新顶牌: 无`);\r\n                }\r\n            })\r\n            .start();\r\n    }\r\n\r\n    /**\r\n     * 更新顶牌信息\r\n     */\r\n    private updateTopCard(): void {\r\n        const currentTopCard = DataManager.instance.gameModel.topCard;\r\n        if (currentTopCard) {\r\n            console.log(`更新顶牌: ${this.getSuitName(currentTopCard.config.CardSuit)}${this.getFaceName(currentTopCard.config.CardFace)}`);\r\n        } else {\r\n            console.log(`更新顶牌: 无`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 计算卡牌的目标位置\r\n     * @param cardData 卡牌数据\r\n     * @returns 目标位置 {x, y}\r\n     */\r\n    private calculateTargetPosition(cardData: CardModel): { x: number, y: number } {\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n        const handConf = layoutConfig?.handLayout;\r\n\r\n        // 获取手牌最后一张卡牌节点\r\n        const handCards = Array.from(DataManager.instance.gameModel.handCards.values());\r\n        const lastHandCard = handCards[handCards.length - 1];\r\n\r\n        if (lastHandCard) {\r\n            // 遍历tableArea的所有子节点，找到对应的卡牌节点\r\n            const children = this.tableArea.children;\r\n            for (let i = 0; i < children.length; i++) {\r\n                const child = children[i];\r\n                const cardId = (child as any).cardId;\r\n\r\n                if (cardId === lastHandCard.id) {\r\n                    // 找到手牌最后一张的节点\r\n                    // 获取手牌最后一张的位置（相对于tableArea）\r\n                    const position = child.getPosition();\r\n\r\n                    console.log(`手牌最后一张位置: (${position.x}, ${position.y})`);\r\n\r\n                    return { x: position.x, y: position.y };\r\n                }\r\n            }\r\n\r\n            console.log('未找到手牌最后一张的节点');\r\n        }\r\n\r\n        // 如果找不到手牌最后一张，返回配置中的默认位置\r\n        return {\r\n            x: handConf?.separateCardX ?? 200,\r\n            y: handConf?.separateCardY ?? 0\r\n        };\r\n    }\r\n\r\n    /**\r\n     * 获取花色名称\r\n     */\r\n    private getSuitName(suit: number): string {\r\n        const suits = ['♠', '♥', '♣', '♦'];\r\n        return suits[suit] || '?';\r\n    }\r\n\r\n    /**\r\n     * 获取牌面名称\r\n     */\r\n    private getFaceName(face: number): string {\r\n        const faces = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];\r\n        return faces[face] || '?';\r\n    }\r\n\r\n    /**\r\n     * 撤销上一步操作\r\n     */\r\n    public onUndoClick(): void {\r\n        const success = DataManager.instance.undo();\r\n        if (success) {\r\n            console.log('撤销成功！');\r\n            // 刷新所有卡牌显示\r\n            this.refreshAllCardsDisplay();\r\n            // 更新顶牌信息\r\n            this.updateTopCard();\r\n        } else {\r\n            console.log('无法撤销');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 从节点获取卡牌数据\r\n     */\r\n    private getCardDataFromNode(cardNode: Node): CardModel | undefined {\r\n        const cardId = (cardNode as any).cardId;\r\n\r\n        if (!cardId) {\r\n            console.log('节点上没有cardId属性');\r\n            return undefined;\r\n        }\r\n\r\n        const cardData = DataManager.instance.gameModel.getCardById(cardId);\r\n\r\n        return cardData;\r\n    }\r\n\r\n    /**\r\n     * 刷新卡牌显示\r\n     */\r\n    private refreshCardDisplay(cardNode: Node, cardData: CardModel): void {\r\n        this.setupCardDisplay(cardNode, cardData);\r\n    }\r\n\r\n    /**\r\n     * 移除手牌最后一张的视图\r\n     */\r\n    private removeLastHandCardView(): void {\r\n        const lastCard = DataManager.instance.gameModel.getLastHandCard();\r\n        if (lastCard) {\r\n            // 遍历tableArea的所有子节点，找到对应的卡牌节点\r\n            const children = this.tableArea.children;\r\n            for (let i = 0; i < children.length; i++) {\r\n                const child = children[i];\r\n                const cardId = (child as any).cardId;\r\n\r\n                if (cardId === lastCard.id) {\r\n                    child.removeFromParent();\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 刷新手牌显示\r\n     */\r\n    private refreshHandCardsDisplay(): void {\r\n        // 移除所有手牌节点\r\n        const children = this.tableArea.children;\r\n        for (let i = children.length - 1; i >= 0; i--) {\r\n            const child = children[i];\r\n            const cardId = (child as any).cardId;\r\n            const cardData = DataManager.instance.gameModel.handCards.get(cardId);\r\n\r\n            // 如果是手牌，则移除\r\n            if (cardData) {\r\n                child.removeFromParent();\r\n            }\r\n        }\r\n\r\n        // 重新创建手牌\r\n        const totalHandCards = DataManager.instance.gameModel.handCards.size;\r\n        const layoutConfig = GameConfig.instance.layoutConfig;\r\n\r\n        DataManager.instance.gameModel.handCards.forEach((cardData) => {\r\n            this.createHandCard(cardData, layoutConfig, totalHandCards);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 刷新所有卡牌显示\r\n     */\r\n    private refreshAllCardsDisplay(): void {\r\n        this.createCardsFromData();\r\n    }\r\n}\r\n"]}